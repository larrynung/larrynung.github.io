---
layout: post
title: "[.NET Concept][C#][VB.NET].NET兩個表單間的資料互通"
date: 2009-03-24 12:44:08
comments: true
categories: [C#,VB.NET,.NET Concept]
description: "[.NET Concept][C#][VB.NET].NET兩個表單間的資料互通"
---
<p>
	常會看到有人詢問兩個表單間的資料要如何互通，重覆詢問率之高讓該問題約可列入初學者必問的前幾大問題了，光在程式設計俱樂部大概這類問題我大概就已回答過4~5次了。最近又在批踢踢討論版中看到有人詢問，索性想說乾脆就整理一篇以後直接貼連結好了。</p>
<p>
	基本上要讓兩個表單間的資料達到互通大概有下列兩種方法：</p>
<p>
	 </p>
<h3>
	方法一 使用Public欄位、屬性、或方法互通表單資料</h3>
<p>
	 <img alt="image" border="0" height="117" src="\images\posts\7669\image_thumb.png" style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" width="440" /></p>
<p>
	如上圖所示，假設今天我們有兩個表單Form1跟Form2，且Form2由Form1所叫起，在這樣的條件之下，若Form1想要取得Form2上面的資料，相信應該對大家來說都不是問題，直接在Form1上使用Form2的Public欄位、屬性、或方法就可以了。如下程式所示，透過這些Public的成員，我們很容易的可以把Form1的資料送給Form2，也很容易的可以由Form1把Form2上的資料取回。</p>
<p>
	舉個例子來說，假如Form2內的資料存取範圍為Public或是Friend(控制項的話則如下圖把Modifiers屬性值設為Public或是Friend)。</p>
<p>
	 <img alt="image" border="0" height="170" src="\images\posts\7669\image_thumb_2.png" style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" width="441" /></p>
<p>
	<img alt="image" border="0" height="168" src="\images\posts\7669\image_thumb_3.png" style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" width="439" /></p>
<p>
	則我們可以在Form1中透過Form2的物件參考直接去控制Form2的控制項或是內部的資料。</p>
<p>
	VB.NET</p>
<div class="csharpcode">
	<pre class="alt">
<span class="rem">'透過Form2的Public成員把Form1的資料送給Form2</span></pre>
	<pre>
Form2.NumericUpDown1.Value = <span class="kwrd">Me</span>.NumericUpDown1.Value</pre>
</div>
<p>
	C#</p>
<div class="csharpcode">
	<pre class="alt">
<span class="rem">//透過Form2的Public成員把Form1的資料送給Form2</span></pre>
	<pre>
Form2.NumericUpDown1.Value = <span class="kwrd">this</span>.NumericUpDown1.Value;</pre>
</div>
<p>
	 </p>
<p>
	很簡單吧？不過這並不是很好的寫法，因為此種寫法違反了物件導向的封裝原則。較好的寫法是利用屬性去封裝，首先我們需要把Form2的資料存取範圍設為Private(控制項的話則如下圖把Modifiers屬性值設為Private)，讓類別外無法直接做存取的動作。</p>
<p>
	<img alt="image" border="0" height="168" src="\images\posts\7669\image_thumb_1.png" style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" width="437" /></p>
<p>
	接著，我們可以撰寫如下的Code，利用屬性封裝Form2的控制項甚至是內部的資料。</p>
<p>
	VB.NET</p>
<div class="csharpcode">
	<pre class="alt">
    <span class="kwrd">Property</span> Value() <span class="kwrd">As</span> <span class="kwrd">Decimal</span></pre>
	<pre>
        <span class="kwrd">Get</span></pre>
	<pre class="alt">
            <span class="kwrd">Return</span> NumericUpDown1.Value</pre>
	<pre>
        <span class="kwrd">End</span> <span class="kwrd">Get</span></pre>
	<pre class="alt">
        <span class="kwrd">Set</span>(<span class="kwrd">ByVal</span> value <span class="kwrd">As</span> <span class="kwrd">Decimal</span>)</pre>
	<pre>
            NumericUpDown1.Value = value</pre>
	<pre class="alt">
        <span class="kwrd">End</span> <span class="kwrd">Set</span></pre>
	<pre>
    <span class="kwrd">End</span> Property</pre>
</div>
<p>
	C#</p>
<div class="csharpcode">
	<pre class="alt">
<span class="kwrd">public</span> <span class="kwrd">decimal</span> Value {</pre>
	<pre>
    get { <span class="kwrd">return</span> NumericUpDown1.Value; }</pre>
	<pre class="alt">
    set { NumericUpDown1.Value = <span class="kwrd">value</span>; }</pre>
	<pre>
}</pre>
</div>
<p>
	 </p>
<p>
	用屬性封裝好後我們就可以在Form1中透過Form2的物件參考，藉由Form2的Public屬性控制Form2的控制項或內部的資料。</p>
<p>
	VB.NET</p>
<div class="csharpcode">
	<pre class="alt">
Form2.Value = 123</pre>
</div>
<div class="csharpcode">
	 </div>
<p>
	C#</p>
<p>
	 </p>
<div class="csharpcode">
	<pre class="alt">
Form2.Value = 123;</pre>
</div>
<p>
	 </p>
<p>
	介紹完Form1如何取得Form2上面的資料後，反過來要是Form2想要主動取得或設定Form1的資料呢？其實也很簡單，如下程式所示，只要把上面的概念活用，在Form2被Form1叫起後透過建構子或Public屬性把Form1的物件參考傳到Form2內，Form2就可以用Form1傳進來的物件參考對Form1內的Public成員做想要的動作。</p>
<p>
	VB.NET</p>
<div>
	<pre class="csharpcode">
<span class="kwrd">Public</span> <span class="kwrd">Class</span> Form1  
...
      <span class="rem">'Form1透過Form2的Public成員把自身的物件參考傳入Form2</span>
      Form2.MainForm = <span class="kwrd">Me</span>
...
<span class="kwrd">End</span> <span class="kwrd">Class</span>

<span class="kwrd">Public</span> <span class="kwrd">Class</span> Form2
...
<span class="kwrd">      Public</span> MainForm <span class="kwrd">As</span> Form1
...
      <span class="rem">'Form2透過Form1傳進的物件參考控制Form1</span>
      MainForm.Value = <span class="kwrd">Me</span>.NumericUpDown1.Value
...
<span class="kwrd">End</span> Class</pre>
</div>
<p class="csharpcode">
	 </p>
<p>
	C#</p>
<div class="csharpcode">
	<pre class="alt">
Public Class Form1</pre>
	<pre>
{ </pre>
	<pre class="alt">
...</pre>
	<pre>
      <span class="rem">//Form1透過Form2的Public成員把自身的物件參考傳入Form2</span></pre>
	<pre class="alt">
      Form2.MainForm = <span class="kwrd">this</span>;</pre>
	<pre>
...</pre>
	<pre class="alt">
}</pre>
	<pre>
 </pre>
	<pre class="alt">
Public Class Form2</pre>
	<pre>
{</pre>
	<pre class="alt">
...</pre>
	<pre>
      Public Form1 MainForm;</pre>
	<pre class="alt">
...</pre>
	<pre>
      <span class="rem">//'Form2透過Form1傳進的物件參考控制Form1</span></pre>
	<pre class="alt">
      MainForm.Value = <span class="kwrd">this</span>.NumericUpDown1.Value;</pre>
	<pre>
...</pre>
	<pre class="alt">
}</pre>
</div>
<p class="csharpcode">
	 </p>
<p class="csharpcode">
	 </p>
<p>
	值得注意的是，上述方法我是為了示範較簡單的方式才會把Form1的物件參考傳入Form2，實際使用上，能避免這樣寫還是建議盡量避免，因為這樣會讓Form1跟Form2的耦合性提高，較好的方法是直接Binding。</p>
<p>
	 </p>
<p>
	或是在Form2內定義一些對應的事件，Form1在這些事件觸發時再利用Form2的物件做對應的處理。</p>
<p>
	程式大概如下：</p>
<div>
	<div style="width: 745px; height: 214px; overflow: auto">
		<div class="csharpcode">
			<pre class="alt">
<span class="kwrd">Public</span> <span class="kwrd">Class</span> Form1</pre>
			<pre>
...</pre>
			<pre class="alt">
       <span class="kwrd">AddHandler</span> Form2.SetValueToForm1, <span class="kwrd">AddressOf</span> OnSetValueToForm1</pre>
			<pre>
...</pre>
			<pre class="alt">
   <span class="kwrd">Private</span> <span class="kwrd">Sub</span> OnSetValueToForm1(<span class="kwrd">ByVal</span> sender <span class="kwrd">As</span> <span class="kwrd">Object</span>, <span class="kwrd">ByVal</span> e <span class="kwrd">As</span> EventArgs)</pre>
			<pre>
        <span class="kwrd">Me</span>.NumericUpDown1.Value = Form2.Value        <span class="rem">'把Form2的資料送給Form1</span></pre>
			<pre class="alt">
    <span class="kwrd">End</span> <span class="kwrd">Sub</span></pre>
			<pre>
...</pre>
			<pre class="alt">
<span class="kwrd">End</span> <span class="kwrd">Class</span></pre>
			<pre>
 </pre>
			<pre class="alt">
<span class="kwrd">Public</span> <span class="kwrd">Class</span> Form2</pre>
			<pre>
...</pre>
			<pre class="alt">
   <span class="kwrd">Event</span> SetValueToForm1 <span class="kwrd">As</span> EventHandler</pre>
			<pre>
 </pre>
			<pre class="alt">
    <span class="kwrd">Protected</span> <span class="kwrd">Sub</span> OnSetValueToForm1(<span class="kwrd">ByVal</span> e <span class="kwrd">As</span> EventArgs)</pre>
			<pre>
        <span class="kwrd">RaiseEvent</span> SetValueToForm1(<span class="kwrd">Me</span>, e)</pre>
			<pre class="alt">
    <span class="kwrd">End</span> <span class="kwrd">Sub</span></pre>
			<pre>
 </pre>
			<pre class="alt">
    <span class="kwrd">Private</span> <span class="kwrd">Sub</span> Button1_Click(<span class="kwrd">ByVal</span> sender <span class="kwrd">As</span> System.<span class="kwrd">Object</span>, <span class="kwrd">ByVal</span> e <span class="kwrd">As</span> System.EventArgs) <span class="kwrd">Handles</span> Button1.Click</pre>
			<pre>
        OnSetValueToForm1(<span class="kwrd">New</span> EventArgs)       </pre>
			<pre class="alt">
    <span class="kwrd">End</span> <span class="kwrd">Sub</span></pre>
			<pre>
...</pre>
			<pre class="alt">
<span class="kwrd">End</span> Class</pre>
		</div>
	</div>
</div>
<div>
	 </div>
<p>
	P.S.這邊初學者很容易犯的問題就是會在Form2內再宣告出一個Form1，並對宣告出的Form1做資料互傳，最後的結果當然是資料互傳後結果不如預期。這是因為沒認清物件參考的原因，每宣告一個物件實體作業系統都會分配一塊記憶體空間，因此需認清本來的Form1表單與Form2內新宣告的Form1是不同的物件參考這個事實。</p>
<p>
	 </p>
<h3>
	方法二 透過靜態變數互通表單資料</h3>
<p>
	透過靜態變數也是可以互通表單資料的方法，使用起來很簡單，只要宣告個靜態變數，接著把該靜態變數指向物件參考，則程式內就可透過該靜態變數做資料的互通，但是該方法較不建議採用。</p>
<p class="csharpcode">
	 </p>
<p class="csharpcode">
	附帶一提，微軟的Beginner Developer Learning Center有此議題的教學影片，有興趣的可點選下方連結自行參閱：</p>
<h5>
	Tier 3: Exchange Data Between Two Forms in a Windows Forms Application</h5>
<p class="csharpcode">
	 </p>
<h2>
	Download</h2>
<p class="csharpcode">
	CommunicationBetweenTwoForm.zip</p>
