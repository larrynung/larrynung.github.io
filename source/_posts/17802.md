---
layout: post
title: ".NET 4.0 New Feature - 程式碼合約(Code Contracts) (三) Contract.Assert & Contract.Assume"
date: 2010-09-19 12:17:30
comments: true
tags: [CSharp]
description: ".NET 4.0 New Feature - 程式碼合約(Code Contracts) (三) Contract.Assert & Contract.Assume"
---
<p>斷言(Assertions)合約主要用於描述某一特定程式點所需滿足的驗證條件，可透過Contract.Assert方法表示，使用上可直接帶入驗證條件：</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:fb946baf-0fd5-41e6-8938-f3d45f189dc8" class="wlWriterSmartContent"><pre name="code" class="c#">
Contract.Assert(this.privateField &gt; 0); </pre></div>  <p> </p>  <p>除了驗證條件外，斷言合約方法也可以附加帶入驗證錯誤時所要顯示的錯誤訊息。</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:baf979db-88ab-4cba-86f0-d34effe1e47f" class="wlWriterSmartContent"><pre name="code" class="c#">
Contract.Assert(this.x == 3, "Why isn't the value of x 3?");</pre></div>  <p> </p>  <p>該合約只能運行在Debug模式，或是在設定有CONTRACTS_FULL前置編譯器的情況。</p>  <p><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" width="352" height="125" src="\images\posts\17802\image_thumb.png" /></p>  <p> </p>  <p>方法用途跟Debug.Assert十分類似，舉凡所以可使用Debug.Assert做驗證的地方，都可以使用Contract.Assert替換。唯一的差異只在於Contract.Assert能享有Code Contract所具有的優點。</p>  <p> </p>  <p>而至於假定(Assumptions)合約方法，跟Contract.Assert很類似，也是用來描述某一特定程式點所需滿足的驗證條件，可減少不必要的警告訊息。透過Contract.Assume方法表示，使用上可直接帶入驗證條件：</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:12886cb1-ad31-4589-a61c-fa7d1cc80bc2" class="wlWriterSmartContent"><pre name="code" class="c#">
Contract.Assume(this.privateField &gt; 0);</pre></div>  <p> </p>  <p>或是帶入驗證條件與驗證錯誤時所要顯示的錯誤訊息：</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:7565fe19-a77e-4b67-874a-a83a34fdae2b" class="wlWriterSmartContent"><pre name="code" class="c#">
Contract.Assume(this.x == 3, "Static checker assumed this");</pre></div>  <p> </p>  <p>介紹到這邊，相信應該都還是無法區別Contract.Assert與Contract.Assume的差異。其實兩者的差異只是在於靜態分析的嚴謹程度，Contract.Assert在使用上會比Contract.Assume來得嚴謹，這邊來看段範例會更清楚些。假設我們撰寫了段程式如下：</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:218187ff-ac55-48fc-a489-34f3d83b38fc" class="wlWriterSmartContent"><pre name="code" class="c#">
        static void Main(string[] args)
        {
           int x = CalculateSomeValues();
           Contract.Assert(x &gt; 0);
        }

        public static int CalculateSomeValues()
        {           
            Contract.Ensures(Contract.Result&lt;int&gt;() &gt; 0);
            return 1;
        }</pre></div>  <p> </p>  <p>由於在CalculateSomeValues函式內，已經用後置條件去驗證了函式回傳值，因此在Main裡面的Contract.Assert就可以確定x變數一定會滿足驗證條件，故整個程式在做靜態分析時是會通過驗證的。</p>  <p> </p>  <p>而若今天我們的函式並未用後置條件去確保有正確的函式回傳值的話，這樣的程式在Contract.Assert那段就會被檢查出有問題。因為回傳值不確定，這個Assert在靜態分析中就無法被驗證，也就無法確定x變數一定會大於零。       </p>  <p><img style="border-bottom: 0px; border-left: 0px; border-top: 0px; border-right: 0px" border="0" alt="image" width="398" height="244" src="\images\posts\17802\image_thumb_2.png" /></a> </p>  <p><a href="http://files.dotblogs.com.tw/larrynung/1009/.NET4.0NewFeatureCodeContracts_B520/image_4.png"><img style="border-bottom: 0px; border-left: 0px; border-top: 0px; border-right: 0px" border="0" alt="image" width="447" height="129" src="\images\posts\17802\image_thumb_1.png" /></a></p>  <p> </p>  <p>這時若仍不想為函式加入後置方法，讓整個驗證更為嚴謹的話，可以使用Contract.Assume來做驗證的動作。</p>  <p><a href="http://files.dotblogs.com.tw/larrynung/1009/.NET4.0NewFeatureCodeContracts_B520/image_8.png"><img style="border-bottom: 0px; border-left: 0px; border-top: 0px; border-right: 0px" border="0" alt="image" width="404" height="247" src="\images\posts\17802\image_thumb_3.png" /></a></p>  <p><a href="http://files.dotblogs.com.tw/larrynung/1009/.NET4.0NewFeatureCodeContracts_B520/image_10.png"><img style="border-bottom: 0px; border-left: 0px; border-top: 0px; border-right: 0px" border="0" alt="image" width="332" height="124" src="\images\posts\17802\image_thumb_4.png" /></p>