---
layout: post
title: "[VB.NET].NET多語系程式(三)"
date: 2009-04-29 12:05:15
comments: true
tags: [VB.NET]
description: "[VB.NET].NET多語系程式(三)"
---
<h2><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" width="562" height="162" src="\images\posts\8234\image_thumb_2.png" /></a></h2><h2>Abstract</h2><ul><li>Introduction</li><li>學習目標</li><li>操作步驟</li><li>簡易實作範例</li></ul><p> </p><h2>Introduction</h2><p>本篇將介紹.NET多語系程式的寫法 ，下面會利用XML文件來達到多語系的功能。</p><p> </p><h2>學習目標</h2><ul><li>.NET多語程式撰寫 </li><li>用XML文件實現多語功能</li><li>XML序列化與解序列化</li></ul><p> </p><h2>操作步驟</h2><p><strong>Step1.建立內含多語訊息的XML文件</strong></p><p>XML文件格式可能如下，內含CultureInfo代碼與對應的訊息字串。</p><p><a href="http://files.dotblogs.com.tw/larrynung/0904/26a4ec5adf00.NET_14AB9/image_2.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" width="540" height="221" src="\images\posts\8234\image_thumb.png" /></a></p><p> </p><p><strong>Step2.切換語系時，從XML文件中抓取對應的顯示字串</strong></p><p><a href="http://files.dotblogs.com.tw/larrynung/0904/26a4ec5adf00.NET_14AB9/image_4.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" width="304" height="84" src="\images\posts\8234\image_thumb_1.png" /></a></p><p><a href="http://files.dotblogs.com.tw/larrynung/0904/26a4ec5adf00.NET_14AB9/image_8.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" width="304" height="84" src="\images\posts\8234\image_thumb_3.png" /></a></p><p><a href="http://files.dotblogs.com.tw/larrynung/0904/26a4ec5adf00.NET_14AB9/image_10.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" width="304" height="84" src="\images\posts\8234\image_thumb_4.png" /></p><p> </p><h2>簡易實作範例</h2><p>基本上這邊只是提示多語程式功能可透過XML文件實現，實現步驟大概如上面所述。然而XML文件的格式與存取的方法與寫法則就看個人怎樣編寫。這邊提供個簡易的範例：</p><p><strong>MultiLanguage類別</strong></p><p>MultiLanguage類別的Code如下</p><p /><style type="text/css"><![CDATA[


.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style><div style="width: 692px; height: 240px; overflow: auto"><div class="csharpcode"><pre class="alt"><span class="kwrd">Imports</span> System.Globalization</pre><pre><span class="kwrd">Imports</span> System.Threading</pre><pre class="alt"><span class="kwrd">Imports</span> System.Xml.Serialization</pre><pre>
 </pre><pre class="alt"><span class="kwrd">Public</span> <span class="kwrd">Class</span> MultiLanguage</pre><pre>
    <span class="kwrd">Implements</span> IXmlSerializable</pre><pre class="alt">
 </pre><pre>
 </pre><pre class="alt"><span class="preproc">#Region</span> <span class="str">"Var"</span></pre><pre>
    <span class="kwrd">Private</span> _pool <span class="kwrd">As</span> <span class="kwrd">New</span> Hashtable</pre><pre class="alt"><span class="preproc">#End Region</span></pre><pre>
 </pre><pre class="alt"><span class="preproc">#Region</span> <span class="str">"Public Shared Method"</span></pre><pre>
    <span class="kwrd">Public</span> <span class="kwrd">Shared</span> <span class="kwrd">Function</span> GetFromXml(<span class="kwrd">ByVal</span> file <span class="kwrd">As</span> <span class="kwrd">String</span>) <span class="kwrd">As</span> MultiLanguage</pre><pre class="alt">
        <span class="kwrd">Dim</span> m <span class="kwrd">As</span> MultiLanguage</pre><pre>
        <span class="kwrd">Dim</span> x <span class="kwrd">As</span> <span class="kwrd">New</span> Xml.Serialization.XmlSerializer(<span class="kwrd">GetType</span>(MultiLanguage))</pre><pre class="alt">
        <span class="kwrd">Dim</span> fs <span class="kwrd">As</span> <span class="kwrd">New</span> IO.FileStream(file, IO.FileMode.Open)</pre><pre>
        m = <span class="kwrd">CType</span>(x.Deserialize(fs), MultiLanguage)</pre><pre class="alt">
        fs.Dispose()</pre><pre>
        <span class="kwrd">Return</span> m</pre><pre class="alt">
    <span class="kwrd">End</span> <span class="kwrd">Function</span></pre><pre><span class="preproc">#End Region</span></pre><pre class="alt">
 </pre><pre><span class="preproc">#Region</span> <span class="str">"Public Method"</span></pre><pre class="alt">
    <span class="kwrd">Public</span> <span class="kwrd">Sub</span> AddString(<span class="kwrd">ByVal</span> key <span class="kwrd">As</span> <span class="kwrd">String</span>, <span class="kwrd">ByVal</span> msg <span class="kwrd">As</span> <span class="kwrd">String</span>, <span class="kwrd">ByVal</span> culture <span class="kwrd">As</span> <span class="kwrd">String</span>)</pre><pre>
        <span class="kwrd">If</span> <span class="kwrd">Not</span> _pool.ContainsKey(key) <span class="kwrd">Then</span></pre><pre class="alt">
            _pool.Add(key, <span class="kwrd">New</span> Hashtable)</pre><pre>
        <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre class="alt">
        <span class="kwrd">CType</span>(_pool(key), Hashtable).Add(culture, msg)</pre><pre>
    <span class="kwrd">End</span> <span class="kwrd">Sub</span></pre><pre class="alt">
 </pre><pre>
    <span class="kwrd">Public</span> <span class="kwrd">Sub</span> AddString(<span class="kwrd">ByVal</span> key <span class="kwrd">As</span> <span class="kwrd">String</span>, <span class="kwrd">ByVal</span> msg <span class="kwrd">As</span> <span class="kwrd">String</span>)</pre><pre class="alt">
        AddString(key, msg, Thread.CurrentThread.CurrentCulture.Name)</pre><pre>
    <span class="kwrd">End</span> <span class="kwrd">Sub</span></pre><pre class="alt">
 </pre><pre>
    <span class="kwrd">Public</span> <span class="kwrd">Function</span> GetString(<span class="kwrd">ByVal</span> key <span class="kwrd">As</span> <span class="kwrd">String</span>, <span class="kwrd">ByVal</span> culture <span class="kwrd">As</span> <span class="kwrd">String</span>) <span class="kwrd">As</span> <span class="kwrd">String</span></pre><pre class="alt">
        <span class="kwrd">If</span> <span class="kwrd">Not</span> _pool.ContainsKey(key) <span class="kwrd">Then</span></pre><pre>
            <span class="kwrd">Return</span> <span class="kwrd">String</span>.Empty</pre><pre class="alt">
        <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre>
        <span class="kwrd">Dim</span> msgPool <span class="kwrd">As</span> Hashtable = <span class="kwrd">CType</span>(_pool(key), Hashtable)</pre><pre class="alt">
        <span class="kwrd">If</span> <span class="kwrd">Not</span> msgPool.ContainsKey(culture) <span class="kwrd">Then</span></pre><pre>
            <span class="kwrd">Return</span> <span class="kwrd">String</span>.Empty</pre><pre class="alt">
        <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre>
        <span class="kwrd">Return</span> msgPool(culture).ToString</pre><pre class="alt">
    <span class="kwrd">End</span> <span class="kwrd">Function</span></pre><pre>
 </pre><pre class="alt">
    <span class="kwrd">Public</span> <span class="kwrd">Function</span> GetString(<span class="kwrd">ByVal</span> key <span class="kwrd">As</span> <span class="kwrd">String</span>) <span class="kwrd">As</span> <span class="kwrd">String</span></pre><pre>
        <span class="kwrd">Return</span> GetString(key, Thread.CurrentThread.CurrentCulture.Name)</pre><pre class="alt">
    <span class="kwrd">End</span> <span class="kwrd">Function</span></pre><pre>
 </pre><pre class="alt">
    <span class="kwrd">Public</span> <span class="kwrd">Sub</span> SaveXml(<span class="kwrd">ByVal</span> file <span class="kwrd">As</span> <span class="kwrd">String</span>)</pre><pre>
        <span class="kwrd">Dim</span> x <span class="kwrd">As</span> <span class="kwrd">New</span> Xml.Serialization.XmlSerializer(<span class="kwrd">GetType</span>(MultiLanguage))</pre><pre class="alt">
        <span class="kwrd">Dim</span> fs <span class="kwrd">As</span> <span class="kwrd">New</span> IO.FileStream(file, IO.FileMode.Create)</pre><pre>
        x.Serialize(fs, <span class="kwrd">Me</span>)</pre><pre class="alt">
        fs.Dispose()</pre><pre>
    <span class="kwrd">End</span> <span class="kwrd">Sub</span></pre><pre class="alt"><span class="preproc">#End Region</span></pre><pre>
 </pre><pre class="alt">
 </pre><pre><span class="preproc">#Region</span> <span class="str">"Implements IXmlSerializable"</span></pre><pre class="alt">
    <span class="kwrd">Public</span> <span class="kwrd">Function</span> GetSchema() <span class="kwrd">As</span> System.Xml.Schema.XmlSchema <span class="kwrd">Implements</span> System.Xml.Serialization.IXmlSerializable.GetSchema</pre><pre>
        <span class="kwrd">Return</span> <span class="kwrd">Nothing</span></pre><pre class="alt">
    <span class="kwrd">End</span> <span class="kwrd">Function</span></pre><pre>
 </pre><pre class="alt">
    <span class="kwrd">Public</span> <span class="kwrd">Sub</span> ReadXml(<span class="kwrd">ByVal</span> reader <span class="kwrd">As</span> System.Xml.XmlReader) <span class="kwrd">Implements</span> System.Xml.Serialization.IXmlSerializable.ReadXml</pre><pre>
        <span class="kwrd">Dim</span> startElementName <span class="kwrd">As</span> <span class="kwrd">String</span> = reader.Name</pre><pre class="alt">
        <span class="kwrd">Dim</span> currentElementName <span class="kwrd">As</span> <span class="kwrd">String</span></pre><pre>
 </pre><pre class="alt">
        <span class="kwrd">Do</span></pre><pre>
            currentElementName = reader.Name</pre><pre class="alt">
            <span class="kwrd">If</span> currentElementName = startElementName <span class="kwrd">AndAlso</span> (reader.MoveToContent = Xml.XmlNodeType.EndElement <span class="kwrd">OrElse</span> reader.IsEmptyElement) <span class="kwrd">Then</span></pre><pre>
                reader.Read()</pre><pre class="alt">
                <span class="kwrd">Exit</span> <span class="kwrd">Do</span></pre><pre>
            <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre class="alt">
 </pre><pre>
 </pre><pre class="alt">
            <span class="kwrd">Select</span> <span class="kwrd">Case</span> currentElementName</pre><pre>
                <span class="kwrd">Case</span> <span class="str">"Item"</span></pre><pre class="alt">
                    <span class="kwrd">Dim</span> key <span class="kwrd">As</span> <span class="kwrd">String</span> = reader.GetAttribute(<span class="str">"Key"</span>)</pre><pre>
                    <span class="kwrd">Dim</span> cultureKey <span class="kwrd">As</span> <span class="kwrd">String</span> = reader.GetAttribute(<span class="str">"Culture"</span>)</pre><pre class="alt">
                    <span class="kwrd">Dim</span> value <span class="kwrd">As</span> <span class="kwrd">String</span> = reader.ReadString()</pre><pre>
                    reader.ReadEndElement()</pre><pre class="alt">
                    AddString(key, value, cultureKey)</pre><pre>
 </pre><pre class="alt">
                <span class="kwrd">Case</span> <span class="kwrd">Else</span></pre><pre>
                    reader.Read()</pre><pre class="alt">
            <span class="kwrd">End</span> <span class="kwrd">Select</span></pre><pre>
 </pre><pre class="alt">
 </pre><pre>
        <span class="kwrd">Loop</span></pre><pre class="alt">
 </pre><pre>
    <span class="kwrd">End</span> <span class="kwrd">Sub</span></pre><pre class="alt">
 </pre><pre>
    <span class="kwrd">Public</span> <span class="kwrd">Sub</span> WriteXml(<span class="kwrd">ByVal</span> writer <span class="kwrd">As</span> System.Xml.XmlWriter) <span class="kwrd">Implements</span> System.Xml.Serialization.IXmlSerializable.WriteXml</pre><pre class="alt">
        <span class="kwrd">Dim</span> msgPool <span class="kwrd">As</span> Hashtable</pre><pre>
        <span class="kwrd">For</span> <span class="kwrd">Each</span> key <span class="kwrd">As</span> <span class="kwrd">String</span> <span class="kwrd">In</span> _pool.Keys</pre><pre class="alt">
            msgPool = <span class="kwrd">CType</span>(_pool(key), Hashtable)</pre><pre>
            <span class="kwrd">For</span> <span class="kwrd">Each</span> cultureKey <span class="kwrd">As</span> <span class="kwrd">String</span> <span class="kwrd">In</span> msgPool.Keys</pre><pre class="alt">
                writer.WriteStartElement(<span class="str">"Item"</span>)</pre><pre>
                writer.WriteAttributeString(<span class="str">"Key"</span>, key)</pre><pre class="alt">
                writer.WriteAttributeString(<span class="str">"Culture"</span>, cultureKey)</pre><pre>
                writer.WriteString(msgPool(cultureKey).ToString)</pre><pre class="alt">
                writer.WriteEndElement()</pre><pre>
            <span class="kwrd">Next</span></pre><pre class="alt">
        <span class="kwrd">Next</span></pre><pre>
    <span class="kwrd">End</span> <span class="kwrd">Sub</span></pre><pre class="alt"><span class="preproc">#End Region</span></pre><pre>
 </pre><pre class="alt"><span class="kwrd">End</span> <span class="kwrd">Class</span></pre></div></div><p /><style type="text/css"><![CDATA[


.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style><p> </p><p><strong>建立各語系字串</strong></p><div class="csharpcode"><pre class="alt">
m.AddString(<span class="str">"title"</span>, <span class="str">"Title"</span>, <span class="str">"en"</span>)</pre><pre>
m.AddString(<span class="str">"title"</span>, <span class="str">"標題"</span>, <span class="str">"zh-CHT"</span>)</pre><pre class="alt">
m.AddString(<span class="str">"title"</span>, <span class="str">"标题"</span>, <span class="str">"zh-CHS"</span>)</pre></div><p /><style type="text/css"><![CDATA[


.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style><p> </p><p><strong>切換語系</strong></p><div style="width: 694px; height: 211px; overflow: auto"><div class="csharpcode"><pre class="alt">
   <span class="kwrd">Private</span> <span class="kwrd">Sub</span> Button1_Click(<span class="kwrd">ByVal</span> sender <span class="kwrd">As</span> System.<span class="kwrd">Object</span>, <span class="kwrd">ByVal</span> e <span class="kwrd">As</span> System.EventArgs) <span class="kwrd">Handles</span> Button1.Click</pre><pre>
        <span class="kwrd">Me</span>.Text = m.GetString(<span class="str">"title"</span>, <span class="str">"en"</span>)</pre><pre class="alt">
    <span class="kwrd">End</span> <span class="kwrd">Sub</span></pre><pre>
 </pre><pre class="alt">
    <span class="kwrd">Private</span> <span class="kwrd">Sub</span> Button2_Click(<span class="kwrd">ByVal</span> sender <span class="kwrd">As</span> System.<span class="kwrd">Object</span>, <span class="kwrd">ByVal</span> e <span class="kwrd">As</span> System.EventArgs) <span class="kwrd">Handles</span> Button2.Click</pre><pre>
        <span class="kwrd">Me</span>.Text = m.GetString(<span class="str">"title"</span>, <span class="str">"zh-CHT"</span>)</pre><pre class="alt">
    <span class="kwrd">End</span> <span class="kwrd">Sub</span></pre><pre>
 </pre><pre class="alt">
    <span class="kwrd">Private</span> <span class="kwrd">Sub</span> Button5_Click(<span class="kwrd">ByVal</span> sender <span class="kwrd">As</span> System.<span class="kwrd">Object</span>, <span class="kwrd">ByVal</span> e <span class="kwrd">As</span> System.EventArgs) <span class="kwrd">Handles</span> Button5.Click</pre><pre>
        <span class="kwrd">Me</span>.Text = m.GetString(<span class="str">"title"</span>, <span class="str">"zh-CHS"</span>)</pre><pre class="alt">
    <span class="kwrd">End</span> Sub</pre></div></div><p /><style type="text/css"><![CDATA[


.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style><p> </p><p><strong>儲存XML</strong></p><div class="csharpcode"><pre class="alt">
m.SaveXml(<span class="str">"c:\test.xml"</span>)</pre></div><p /><style type="text/css"><![CDATA[


.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style><p> </p><p><strong>讀取XML</strong></p><div class="csharpcode"><pre class="alt"><span class="kwrd">Dim</span> m <span class="kwrd">As</span> MultiLanguage = MultiLanguage.GetFromXml(<span class="str">"c:\test.xml"</span>)</pre></div><p> </p><p><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" width="457" height="332" src="\images\posts\8234\image_thumb_6.png" /></p>