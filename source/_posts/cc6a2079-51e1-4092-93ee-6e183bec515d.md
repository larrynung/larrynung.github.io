---
layout: post
title: "[C#]使用BitmapDecoder快速讀取圖檔的大小"
date: 2013-11-06 12:00:00
comments: true
tags: [CSharp]
description: "[C#]使用BitmapDecoder快速讀取圖檔的大小"
---
<p>一般我們想要讀取圖檔的大小，通常在Windows Form中都是直接載入成Bitmap，再去讀取Bitmap物件的長、寬、或是大小屬性，像是像下面這樣撰寫：</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:2c0d48d9-3912-4ba3-a060-328115661a1f" class="wlWriterSmartContent"><pre name="code" class="c#">...
using (var image = Bitmap.FromFile(file))
{
	var size = image.Size;
	...
}
...</pre></div>

<p> </p>

<p>但這樣做會有個問題就是效率會比較差，因為必須將整個圖檔先行載入，圖檔越大就越久，記憶體也吃的兇。</p>

<p> </p>

<p>比較好的作法應該是直接讀取檔案的檔頭，圖檔的大小資訊再圖檔的檔頭就有了，所以不需要將整個圖檔載入就可以得知，效率也會因此有所增進。比較簡單的作法就是直接使用WPF的功能，若是Window Form程式的話我們可以額外將PresentationCore.dll、System.Xaml、與WindowsBase.dll加入參考。</p>

<p><img style="border-bottom: 0px; border-left: 0px; border-top: 0px; border-right: 0px" border="0" alt="image" src="\images\posts\cc6a2079-51e1-4092-93ee-6e183bec515d\image_thumb_2.png" width="287" height="275" /> </p>

<p> </p>

<p>並引用System.Windows.Media命名空間。</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:1bd0f555-f9cd-47a1-94cb-b8a8f70e44d5" class="wlWriterSmartContent"><pre name="code" class="c#">using System.Windows.Media;</pre></div>

<p> </p>

<p>實際撰寫我們可以用BitmapDecoder.Create將要讀取的圖檔位置帶入，然後取得第一個Frame，裡面的PixelWidth與PixelHeight就是我們所要擷取的圖檔大小。</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:4c2ffe46-7c28-4b82-a9c4-036c1e27c748" class="wlWriterSmartContent"><pre name="code" class="c#">...
var decoder = BitmapDecoder.Create(new Uri(file), BitmapCreateOptions.DelayCreation, BitmapCacheOption.None);
var frame = decoder.Frames.FirstOrDefault();
			
var size = new Size(frame.PixelWidth, frame.PixelHeight);
...</pre></div>

<p> </p>

<p>完整的測試範例如下：</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:bd6bfe6c-81bb-4123-a74e-1b9b72f85f40" class="wlWriterSmartContent"><pre name="code" class="c#">using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.Windows.Media.Imaging;
using System.IO;
using System.Drawing.Imaging;
using System.Windows.Threading;
using System.Windows.Media;
using System.Diagnostics;

namespace WindowsFormsApplication32
{
	public partial class Form1 : Form
	{
		public Form1()
		{
			InitializeComponent();
		}

		private long StopwatchMethod(Action act, int testCount, Boolean returnAverageValue = false)
		{
			var sw = Stopwatch.StartNew();
			for (int i = 0; i &lt; testCount;++i )
				act();

			sw.Stop();
			var elapsedMilliseconds = sw.ElapsedMilliseconds;
			return (returnAverageValue) ? elapsedMilliseconds / testCount : elapsedMilliseconds; 
		}

		public Size GetImageSize1(string file)
		{
			var decoder = BitmapDecoder.Create(new Uri(file), BitmapCreateOptions.DelayCreation, BitmapCacheOption.None);
			var frame = decoder.Frames.FirstOrDefault();
			
			return new Size(frame.PixelWidth, frame.PixelHeight);
		}

		public Size GetImageSize2(string file)
		{
			using (var image = Bitmap.FromFile(file))
			{
				return image.Size;
			}
		}

		private void button1_Click(object sender, EventArgs e)
		{
			if (openFileDialog1.ShowDialog() == System.Windows.Forms.DialogResult.OK)
			{
				var file = openFileDialog1.FileName;

				GetImageSize1(file);
				GetImageSize2(file);

				textBox1.Clear();
				textBox1.Text += "BitmapDecoder" + Environment.NewLine;
				textBox1.Text += StopwatchMethod(() =&gt; GetImageSize1(file), 10).ToString() + Environment.NewLine;

				textBox1.Text += Environment.NewLine;
				textBox1.Text += "Bitmap" + Environment.NewLine;				
				textBox1.Text += StopwatchMethod(() =&gt; GetImageSize2(file), 10).ToString() + Environment.NewLine;
			}
		}
	}
}</pre></div>

<p> </p>

<p>實際運行時筆者帶入大概4~5 MB的圖檔，可以看到光運行十次在效能上就有很大的差異。</p>

<p><img style="border-bottom: 0px; border-left: 0px; border-top: 0px; border-right: 0px" border="0" alt="image" src="\images\posts\cc6a2079-51e1-4092-93ee-6e183bec515d\image_thumb.png" width="304" height="304" /> </p>

<p> </p>

<h2>Link</h2>

<ul>
  <li>Determining height and width of an image without loading it into memory?</li>

  <li>Reading Image Headers to Get Width and Height</li>

  <li>Getting image dimensions without reading the entire file</li>
</ul>