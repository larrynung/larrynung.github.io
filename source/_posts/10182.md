---
layout: post
title: "[C#][VB.NET].NET 4.0 Barrier Class"
date: 2009-08-22 05:32:32
comments: true
tags: [VB.NET,C#]
description: "[C#][VB.NET].NET 4.0 Barrier Class"
---
<h2>Introduction</h2><p>.NET 4.0後在System.Threading命名空間中新加入了Barrier類別，該類別的功能就如同字面意義一樣，可視為是一個關卡或是剪票口。透過Barrier Class我們可以管制執行緒的運作，做到執行緒同步的效果。 <br /> </p><h2>字面意思</h2><p>Barrier [`bærIL]</p><p>n.剪票口;海關關卡;障礙物;路障,柵欄 <br /> </p><h2>Support</h2><ul><li>.NET Framework 4.0 (C# 4.0、VB.NET 10.0) or latter <br /> </li></ul><h2>Assembly</h2><p>System (in System.dll) <br /> </p><h2>Namespace</h2><p>System.Threading</a> <br /> </p><h2>Barrier Class</h2><p>Barrier Class在使用上十分的簡單，只要宣告Barrier物件並在<a target="_blank" href="http://msdn.microsoft.com/en-us/library/system.threading.barrier.barrier(VS.100).aspx">建構函式</a>帶入participantCount(簡單的說就是要等待的執行緒個數)，並在要同步的點叫用<a target="_blank" href="http://msdn.microsoft.com/en-us/library/system.threading.barrier.signalandwait(VS.100).aspx">SignalAndWait</a>即可。</p><p><a rel="lightbox" href="http://files.dotblogs.com.tw/larrynung/0908/655d80e43889_87FB/image_8.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" width="557" height="96" src="\images\posts\10182\image_thumb_3.png" /></a></p><p> </p><p>執行緒會在叫用<a target="_blank" href="http://msdn.microsoft.com/en-us/library/system.threading.barrier.signalandwait(VS.100).aspx">SignalAndWait</a>後會暫停運行，等待所有要參與的執行緒都到了同步點才繼續往下運行。</p><p>舉個例子來看，假設今天Charlie、Mac、Dennis三個人相約要去西雅圖喝咖啡。由於三個人的住的地區不盡相同，且車子都需要加油，因此他們約在途中會經過的加油站待會合後一同前往。</p><p> <a rel="lightbox" href="http://files.dotblogs.com.tw/larrynung/0908/655d80e43889_87FB/image_2.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" width="564" height="283" src="\images\posts\10182\image_thumb.png" /></p><p> </p><p>這樣的情境我們可以透過Thread與Barrier用程式加以模擬出來</p><p>VB.NET</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:5028796f-80f4-4472-9388-bc707eba52d7" class="wlWriterEditableSmartContent"><pre class="vb:nocontrols" name="code">
Imports System.Threading

Module Module1

    Private sync As Barrier

    Sub Main(ByVal args() As String)
        sync = New Barrier(3)

        Dim charlie = New Thread(Sub() DriveToBoston("Charlie", TimeSpan.FromSeconds(1)))
        charlie.Start()
        Dim mac = New Thread(Sub() DriveToBoston("Mac", TimeSpan.FromSeconds(2)))
        mac.Start()
        Dim dennis = New Thread(Sub() DriveToBoston("Dennis", TimeSpan.FromSeconds(3)))
        dennis.Start()

        charlie.Join()
        mac.Join()
        dennis.Join()

        Console.ReadKey()
    End Sub

    Sub DriveToBoston(ByVal name As String, ByVal timeToGasStation As TimeSpan)

        Console.WriteLine("[{0}] Leaving House", name)

        ' Perform some work
        Thread.Sleep(timeToGasStation)
        Console.WriteLine("[{0}] Arrived at Gas Station", name)

        ' Need to sync here
        sync.SignalAndWait()

        ' Perform some more work
        Console.WriteLine("[{0}] Leaving for Gas Station", name)

    End Sub

End Module
</pre></div><p> </p><p> </p><p>C#</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:a72d73c4-5e10-435d-88a6-d2e27c93cc64" class="wlWriterEditableSmartContent"><pre class="c#:nocontrols" name="code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading;

namespace BarrierDemo
{
    class Program
    {
        static Barrier sync;

        static void Main(string[] args)
        {
            sync = new Barrier(3);

            var charlie = new Thread(() =&gt; DriveToBoston("Charlie", TimeSpan.FromSeconds(1))); charlie.Start();
            var mac = new Thread(() =&gt; DriveToBoston("Mac", TimeSpan.FromSeconds(2))); mac.Start();
            var dennis = new Thread(() =&gt; DriveToBoston("Dennis", TimeSpan.FromSeconds(3))); dennis.Start();

            charlie.Join();
            mac.Join();
            dennis.Join();

            Console.ReadKey();
        }

        static void DriveToBoston(string name, TimeSpan timeToGasStation)
        {
            Console.WriteLine("[{0}] Leaving House", name);

            // Perform some work
            Thread.Sleep(timeToGasStation);
            Console.WriteLine("[{0}] Arrived at Gas Station", name);

            // Need to sync here
            sync.SignalAndWait();

            // Perform some more work
            Console.WriteLine("[{0}] Leaving for Gas Station", name);

        }
    }
}</pre></div><p> </p><p> </p><p>運行結果 <br /><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" width="504" height="154" src="\images\posts\10182\image_thumb_1.png" /></a></p><p> </p><p>若是不使用Barrier去同步，這邊我們可以拿掉sync.SignalAndWait()再做一次運行，則三個人就會變成各自前往西雅圖喝咖啡了。 <br /><a rel="lightbox" href="http://files.dotblogs.com.tw/larrynung/0908/655d80e43889_87FB/image_6.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" width="504" height="142" src="\images\posts\10182\image_thumb_2.png" /></a></p><p> </p><h2>Link</h2><ul><li><a target="_blank" href="http://msdn.microsoft.com/en-us/library/system.threading.barrier(VS.100).aspx">MSDN - Barrier Class</a></li><li><a target="_blank" href="http://stackoverflow.com/questions/990970/difference-between-barrier-in-c-4-0-and-waithandle-in-c-3-0">StackOverFlow - Difference between Barrier in C# 4.0 and WaitHandle in C# 3.0?</a></li><li><a target="_blank" href="http://www.managed-world.com/archive/2009/02/09/an-intro-to-barrier.aspx">Managed World - An Intro to Barrier</li></ul>