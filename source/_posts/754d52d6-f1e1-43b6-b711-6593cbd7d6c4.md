---
layout: post
title: "[C#]如何解決在Vista以後開啟檔案FileSystemWatcher無法觸發LastAccess的問題"
date: 2013-11-06 12:00:00
comments: true
categories: 
description: "[C#]如何解決在Vista以後開啟檔案FileSystemWatcher無法觸發LastAccess的問題"
---
<p>
	筆者在論壇中看到FileSystemWatcher在不同系統上的事件觸發問題這篇發問，覺得十分有趣，同樣的程式在不同的OS有不同的結果。為了確定這個問題，筆者實際撰寫了像下面這樣的測試程式做了點測試。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:a1403217-f92c-486b-b9f7-4a0974c0f1c4" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px">
	<pre class="c#" name="code">
		static FileSystemWatcher fw = new FileSystemWatcher();
		static void Main(string[] args)
		{
			fw.NotifyFilter = NotifyFilters.LastAccess;
			fw.Path = @"c:\";
			fw.Changed += fw_Changed;
			fw.EnableRaisingEvents = true;
			Console.ReadKey();
		}

		static void fw_Changed(object sender, FileSystemEventArgs e)
		{
		}</pre>
</div>
<p>
	 </p>
<p>
	發現開啟檔案時在筆者的Win8是不會觸發事件的。</p>
<p>
	 </p>
<p>
	因此上網看了一下是不是有些系統的設定造成的，找到FileSystemWatcher.Changed Event - does it fire when a file is accessed?這篇，發現在Vista後的電腦預設是關閉更新LastAccess的，所以我們在怎麼開啟檔案，在檔案的屬性頁中他的存取日期都不會變動。像筆者在1:30幾分開啟了2.txt檔，它的存取日期也不會變動。</p>
<p>
	<img alt="image" border="0" height="591" src="\images\posts\754d52d6-f1e1-43b6-b711-6593cbd7d6c4\image_thumb_1.png" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" width="439" /></p>
<p>
	 </p>
<p>
	要讓系統更新這個日期的話，我們必須將HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\FileSystem下的NtfsDisableLastAccessUpdate給關閉，像是下面這樣設成0關閉。</p>
<p>
	<img alt="image" border="0" height="553" src="\images\posts\754d52d6-f1e1-43b6-b711-6593cbd7d6c4\image_thumb.png" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" width="666" /></p>
<p>
	 </p>
<p>
	或是直接到How to Enabled or Disable Last Access Updating in Vista這網站下載它包好的登錄檔，點選兩下執行登錄檔的修改也可以。</p>
<p>
	 </p>
<p>
	修改後系統就會開始更新LastAccessTime了，我們一樣可以開啟檔案，然後用檔案的屬性頁來確定，這時應該存取日期會開始正常的更新。</p>
<p>
	<img alt="image" border="0" height="591" src="\images\posts\754d52d6-f1e1-43b6-b711-6593cbd7d6c4\image_thumb_2.png" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" width="439" /></p>
<p>
	 </p>
<p>
	透過FileSystemWatcher來偵測也會正常了。</p>
<p>
	<img alt="image" border="0" height="358" src="\images\posts\754d52d6-f1e1-43b6-b711-6593cbd7d6c4\image_thumb_3.png" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" width="644" /></p>
<p>
	 </p>
<h2>
	Link</h2>
<ul>
	<li>
		FileSystemWatcher在不同系統上的事件觸發問題</li>
	<li>
		FileSystemWatcher.Changed Event - does it fire when a file is accessed?</li>
	<li>
		How to Enabled or Disable Last Access Updating in Vista</li>
</ul>
