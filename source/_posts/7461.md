---
layout: post
title: "[Performance][VB.NET].NET空字串判斷徹底研究"
date: 2009-03-13 08:49:01
comments: true
categories: [Performance,VB.NET]
description: "[Performance][VB.NET].NET空字串判斷徹底研究"
---
<p><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" width="640" height="215" src="\images\posts\7461\image1_thumb.png" /></p><p>.NET下的空字串判斷整體來說大概可分為下列幾種方法：</p><ol><li>用 is Nothing 判斷。e.x. If str Is Nothing</li><li>用 = Nothing 判斷(類別中只有字串可以用 = Nothing 來判斷)。e.x. If str = Nothing</li><li>用 = "" 判斷。e.x. If str = ""</li><li>用 = String.Empty 判斷。e.x. If str = String.Empty</li><li>用 Is String.Empty 判斷。e.x. If str Is String.Empty</li><li>用 String.IsNullOrEmpty(str) 判斷。e.x. If String.IsNullOrEmpty(str)</li><li>用 String.Length = 0 判斷。e.x. If str.Length = 0</li></ol><p> </p><p>上述所列出的空字串判斷方法，其所跑出的效果不盡相同，為了看出其差異性，這邊撰寫了簡單的測試程式如下：</p><div style="width: 721px; height: 317px; overflow: auto"><div class="csharpcode"><pre class="alt">
    <span class="kwrd">Sub</span> Main()</pre><pre>
        <span class="kwrd">Dim</span> testStrings() <span class="kwrd">As</span> <span class="kwrd">String</span> = <span class="kwrd">New</span> <span class="kwrd">String</span>() {<span class="kwrd">Nothing</span>, <span class="str">""</span>, <span class="kwrd">String</span>.Empty}</pre><pre class="alt">
        <span class="kwrd">For</span> <span class="kwrd">Each</span> str <span class="kwrd">As</span> <span class="kwrd">String</span> <span class="kwrd">In</span> testStrings</pre><pre>
            TestString(str)</pre><pre class="alt">
            Console.WriteLine(<span class="str">"======================="</span>)</pre><pre>
        <span class="kwrd">Next</span></pre><pre class="alt">
    <span class="kwrd">End</span> <span class="kwrd">Sub</span>    </pre><pre>
 </pre><pre class="alt">
    <span class="kwrd">Private</span> <span class="kwrd">Sub</span> TestString(<span class="kwrd">ByVal</span> str <span class="kwrd">As</span> <span class="kwrd">String</span>)</pre><pre>
        <span class="kwrd">If</span> str <span class="kwrd">Is</span> <span class="kwrd">Nothing</span> <span class="kwrd">Then</span> Console.WriteLine(<span class="str">"str Is Nothing"</span>)</pre><pre class="alt">
        <span class="kwrd">If</span> str = <span class="kwrd">Nothing</span> <span class="kwrd">Then</span> Console.WriteLine(<span class="str">"str = Nothing"</span>)</pre><pre>
        <span class="kwrd">If</span> str = <span class="str">""</span> <span class="kwrd">Then</span> Console.WriteLine(<span class="str">"str = "</span><span class="str">""</span><span class="str">""</span>)</pre><pre class="alt">
        <span class="kwrd">If</span> str = <span class="kwrd">String</span>.Empty <span class="kwrd">Then</span> Console.WriteLine(<span class="str">"str = String.Empty"</span>)</pre><pre>
        <span class="kwrd">If</span> str <span class="kwrd">Is</span> <span class="kwrd">String</span>.Empty <span class="kwrd">Then</span> Console.WriteLine(<span class="str">"str Is String.Empty"</span>)</pre><pre class="alt">
        <span class="kwrd">If</span> <span class="kwrd">String</span>.IsNullOrEmpty(str) <span class="kwrd">Then</span> Console.WriteLine(<span class="str">"String.IsNullOrEmpty(str)"</span>)</pre><pre>
 </pre><pre class="alt">
        <span class="kwrd">Try</span></pre><pre>
            <span class="kwrd">If</span> str.Length = 0 <span class="kwrd">Then</span> Console.WriteLine(<span class="str">"str.Length = 0"</span>)</pre><pre class="alt">
        <span class="kwrd">Catch</span> ex <span class="kwrd">As</span> Exception</pre><pre>
 </pre><pre class="alt">
        <span class="kwrd">End</span> <span class="kwrd">Try</span></pre><pre>
    <span class="kwrd">End</span> Sub</pre></div></div><p> </p><p>執行結果如下圖所示：</p><p><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" width="644" height="429" src="\images\posts\7461\image_thumb.png" /></p><p> </p><p>由上圖可知， "" 與 String.Empty 結果是一樣的。比較有趣的是，當字串值是""與String.Empty時， str is Nothing 是不會成立的，但是 str = Nothing 卻會成立。而當字串參考是 Nothing 時，str is string.Empty 不成立、 str = string.Empty 成立。這是因為當使用=運算子判斷時，Nothing 、 "" 與 String.Empty 是被視為一樣的，才會造成此有趣的現象。</p><p> </p><p>接著我們來比較一下空字串判斷的執行速度，同樣的我們須撰寫如下測試程式：</p><div style="width: 720px; height: 234px; overflow: auto"><div class="csharpcode"><pre class="alt">
  <span class="kwrd">Sub</span> Main()</pre><pre>
        <span class="kwrd">Dim</span> testStrings() <span class="kwrd">As</span> <span class="kwrd">String</span> = <span class="kwrd">New</span> <span class="kwrd">String</span>() {<span class="kwrd">Nothing</span>, <span class="str">""</span>, <span class="kwrd">String</span>.Empty}</pre><pre class="alt">
        <span class="kwrd">For</span> <span class="kwrd">Each</span> str <span class="kwrd">As</span> <span class="kwrd">String</span> <span class="kwrd">In</span> testStrings</pre><pre>
            TestStringSpeed(str, 10000000)</pre><pre class="alt">
            Console.WriteLine(<span class="str">"======================="</span>)</pre><pre>
        <span class="kwrd">Next</span></pre><pre class="alt">
    <span class="kwrd">End</span> <span class="kwrd">Sub</span></pre><pre>
 </pre><pre class="alt">
    <span class="kwrd">Private</span> <span class="kwrd">Sub</span> TestStringSpeed(<span class="kwrd">ByVal</span> str <span class="kwrd">As</span> <span class="kwrd">String</span>, <span class="kwrd">ByVal</span> count <span class="kwrd">As</span> <span class="kwrd">Integer</span>)</pre><pre>
        <span class="kwrd">Dim</span> n <span class="kwrd">As</span> <span class="kwrd">Integer</span> = count</pre><pre class="alt">
        <span class="kwrd">Dim</span> sw <span class="kwrd">As</span> <span class="kwrd">New</span> Stopwatch</pre><pre>
        Console.WriteLine(<span class="str">"str Is Nothing"</span>)</pre><pre class="alt">
        sw.Start()</pre><pre>
        <span class="kwrd">For</span> i <span class="kwrd">As</span> <span class="kwrd">Integer</span> = 1 <span class="kwrd">To</span> n</pre><pre class="alt">
            <span class="kwrd">If</span> str <span class="kwrd">Is</span> <span class="kwrd">Nothing</span> <span class="kwrd">Then</span></pre><pre>
            <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre class="alt">
        <span class="kwrd">Next</span></pre><pre>
        Console.WriteLine(<span class="str">"花費時間: "</span> &amp; sw.ElapsedMilliseconds)</pre><pre class="alt">
 </pre><pre>
        Console.WriteLine(<span class="str">"str = Nothing"</span>)</pre><pre class="alt">
        sw.Reset()</pre><pre>
        sw.Start()</pre><pre class="alt">
        <span class="kwrd">For</span> i <span class="kwrd">As</span> <span class="kwrd">Integer</span> = 1 <span class="kwrd">To</span> n</pre><pre>
            <span class="kwrd">If</span> str = <span class="kwrd">Nothing</span> <span class="kwrd">Then</span></pre><pre class="alt">
            <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre>
        <span class="kwrd">Next</span></pre><pre class="alt">
        Console.WriteLine(<span class="str">"花費時間: "</span> &amp; sw.ElapsedMilliseconds)</pre><pre>
 </pre><pre class="alt">
        Console.WriteLine(<span class="str">"str = "</span><span class="str">""</span><span class="str">""</span>)</pre><pre>
        sw.Reset()</pre><pre class="alt">
        sw.Start()</pre><pre>
        <span class="kwrd">For</span> i <span class="kwrd">As</span> <span class="kwrd">Integer</span> = 1 <span class="kwrd">To</span> n</pre><pre class="alt">
            <span class="kwrd">If</span> str = <span class="str">""</span> <span class="kwrd">Then</span></pre><pre>
            <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre class="alt">
        <span class="kwrd">Next</span></pre><pre>
        Console.WriteLine(<span class="str">"花費時間: "</span> &amp; sw.ElapsedMilliseconds)</pre><pre class="alt">
 </pre><pre>
        Console.WriteLine(<span class="str">"str = String.Empty"</span>)</pre><pre class="alt">
        sw.Reset()</pre><pre>
        sw.Start()</pre><pre class="alt">
        <span class="kwrd">For</span> i <span class="kwrd">As</span> <span class="kwrd">Integer</span> = 1 <span class="kwrd">To</span> n</pre><pre>
            <span class="kwrd">If</span> str = <span class="kwrd">String</span>.Empty <span class="kwrd">Then</span></pre><pre class="alt">
            <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre>
        <span class="kwrd">Next</span></pre><pre class="alt">
        Console.WriteLine(<span class="str">"花費時間: "</span> &amp; sw.ElapsedMilliseconds)</pre><pre>
 </pre><pre class="alt">
        Console.WriteLine(<span class="str">"str Is String.Empty"</span>)</pre><pre>
        sw.Reset()</pre><pre class="alt">
        sw.Start()</pre><pre>
        <span class="kwrd">For</span> i <span class="kwrd">As</span> <span class="kwrd">Integer</span> = 1 <span class="kwrd">To</span> n</pre><pre class="alt">
            <span class="kwrd">If</span> str <span class="kwrd">Is</span> <span class="kwrd">String</span>.Empty <span class="kwrd">Then</span></pre><pre>
            <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre class="alt">
        <span class="kwrd">Next</span></pre><pre>
        Console.WriteLine(<span class="str">"花費時間: "</span> &amp; sw.ElapsedMilliseconds)</pre><pre class="alt">
 </pre><pre>
        Console.WriteLine(<span class="str">"String.IsNullOrEmpty(str)"</span>)</pre><pre class="alt">
        sw.Reset()</pre><pre>
        sw.Start()</pre><pre class="alt">
        <span class="kwrd">For</span> i <span class="kwrd">As</span> <span class="kwrd">Integer</span> = 1 <span class="kwrd">To</span> n</pre><pre>
            <span class="kwrd">If</span> <span class="kwrd">String</span>.IsNullOrEmpty(str) <span class="kwrd">Then</span></pre><pre class="alt">
            <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre>
        <span class="kwrd">Next</span></pre><pre class="alt">
        Console.WriteLine(<span class="str">"花費時間: "</span> &amp; sw.ElapsedMilliseconds)</pre><pre>
 </pre><pre class="alt">
        <span class="kwrd">Try</span></pre><pre>
            Console.WriteLine(<span class="str">"str.Length = 0"</span>)</pre><pre class="alt">
            sw.Reset()</pre><pre>
            sw.Start()</pre><pre class="alt">
            <span class="kwrd">For</span> i <span class="kwrd">As</span> <span class="kwrd">Integer</span> = 1 <span class="kwrd">To</span> n</pre><pre>
                <span class="kwrd">If</span> str.Length = 0 <span class="kwrd">Then</span></pre><pre class="alt">
 </pre><pre>
                <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre class="alt">
            <span class="kwrd">Next</span></pre><pre>
            Console.WriteLine(<span class="str">"花費時間: "</span> &amp; sw.ElapsedMilliseconds)</pre><pre class="alt">
        <span class="kwrd">Catch</span> ex <span class="kwrd">As</span> Exception</pre><pre>
 </pre><pre class="alt">
        <span class="kwrd">End</span> <span class="kwrd">Try</span></pre><pre>
    <span class="kwrd">End</span> Sub</pre></div></div><p> </p><p /><style type="text/css"><![CDATA[




.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style><p> </p><p>執行結果如下：</p><p><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" width="522" height="484" src="\images\posts\7461\image4_thumb.png" /></p><p>從上圖可看出幾個現象</p><ol><li>用String.IsNullOrEmpty同時判斷Nothing與空字串會比只判斷是否為 Nothing 或為空還慢</li><li>當字串不為 Nothing 時要判斷字串是否為空的話，用Is String.Empty去判斷最快(文件上通常是說String.Length = 0最快)</li></ol><p> </p><p>接著再看個實驗來看當同時判斷Nothing與空字串的情況，測試程式如下：</p><div style="width: 748px; height: 320px; overflow: auto"><div class="csharpcode"><pre class="alt">
   <span class="kwrd">Sub</span> Main()</pre><pre>
        <span class="kwrd">Dim</span> testStrings() <span class="kwrd">As</span> <span class="kwrd">String</span> = <span class="kwrd">New</span> <span class="kwrd">String</span>() {<span class="kwrd">Nothing</span>, <span class="str">""</span>, <span class="kwrd">String</span>.Empty}</pre><pre class="alt">
        <span class="kwrd">For</span> <span class="kwrd">Each</span> str <span class="kwrd">As</span> <span class="kwrd">String</span> <span class="kwrd">In</span> testStrings</pre><pre>
            <span class="rem">'TestString(str)</span></pre><pre class="alt">
            TestStringSpeed(str, 10000000)</pre><pre>
            Console.WriteLine(<span class="str">"======================="</span>)</pre><pre class="alt">
        <span class="kwrd">Next</span></pre><pre>
    <span class="kwrd">End</span> <span class="kwrd">Sub</span></pre><pre class="alt">
 </pre><pre>
 </pre><pre class="alt">
    <span class="kwrd">Private</span> <span class="kwrd">Sub</span> TestStringSpeed(<span class="kwrd">ByVal</span> str <span class="kwrd">As</span> <span class="kwrd">String</span>, <span class="kwrd">ByVal</span> count <span class="kwrd">As</span> <span class="kwrd">Integer</span>)</pre><pre>
        <span class="kwrd">Dim</span> n <span class="kwrd">As</span> <span class="kwrd">Integer</span> = count</pre><pre class="alt">
        <span class="kwrd">Dim</span> sw <span class="kwrd">As</span> <span class="kwrd">New</span> Stopwatch</pre><pre>
        Console.WriteLine(<span class="str">"str Is Nothing &amp; Is String.Empty"</span>)</pre><pre class="alt">
        sw.Start()</pre><pre>
        <span class="kwrd">For</span> i <span class="kwrd">As</span> <span class="kwrd">Integer</span> = 1 <span class="kwrd">To</span> n</pre><pre class="alt">
            <span class="kwrd">If</span> str <span class="kwrd">Is</span> <span class="kwrd">Nothing</span> <span class="kwrd">Then</span></pre><pre>
            <span class="kwrd">Else</span></pre><pre class="alt">
                <span class="kwrd">If</span> str <span class="kwrd">Is</span> <span class="kwrd">String</span>.Empty <span class="kwrd">Then</span></pre><pre>
                <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre class="alt">
            <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre>
 </pre><pre class="alt">
        <span class="kwrd">Next</span></pre><pre>
        Console.WriteLine(<span class="str">"花費時間: "</span> &amp; sw.ElapsedMilliseconds)</pre><pre class="alt">
 </pre><pre>
        Console.WriteLine(<span class="str">"str Is Nothing &amp; Is String.Empty"</span>)</pre><pre class="alt">
        sw.Reset()</pre><pre>
        sw.Start()</pre><pre class="alt">
        <span class="kwrd">For</span> i <span class="kwrd">As</span> <span class="kwrd">Integer</span> = 1 <span class="kwrd">To</span> n</pre><pre>
            <span class="kwrd">If</span> str <span class="kwrd">Is</span> <span class="kwrd">Nothing</span> <span class="kwrd">Then</span></pre><pre class="alt">
            <span class="kwrd">Else</span></pre><pre>
                <span class="kwrd">If</span> str.Length = 0 <span class="kwrd">Then</span></pre><pre class="alt">
                <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre>
            <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre class="alt">
        <span class="kwrd">Next</span></pre><pre>
        Console.WriteLine(<span class="str">"花費時間: "</span> &amp; sw.ElapsedMilliseconds)</pre><pre class="alt">
 </pre><pre>
 </pre><pre class="alt">
        <span class="kwrd">If</span> str = <span class="kwrd">Nothing</span> <span class="kwrd">Then</span> Console.WriteLine(<span class="str">"str = Nothing"</span>)</pre><pre>
        sw.Reset()</pre><pre class="alt">
        sw.Start()</pre><pre>
        <span class="kwrd">For</span> i <span class="kwrd">As</span> <span class="kwrd">Integer</span> = 1 <span class="kwrd">To</span> n</pre><pre class="alt">
            <span class="kwrd">If</span> str = <span class="kwrd">Nothing</span> <span class="kwrd">Then</span></pre><pre>
            <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre class="alt">
        <span class="kwrd">Next</span></pre><pre>
        Console.WriteLine(<span class="str">"花費時間: "</span> &amp; sw.ElapsedMilliseconds)</pre><pre class="alt">
 </pre><pre>
        Console.WriteLine(<span class="str">"str = "</span><span class="str">""</span><span class="str">""</span>)</pre><pre class="alt">
        sw.Reset()</pre><pre>
        sw.Start()</pre><pre class="alt">
        <span class="kwrd">For</span> i <span class="kwrd">As</span> <span class="kwrd">Integer</span> = 1 <span class="kwrd">To</span> n</pre><pre>
            <span class="kwrd">If</span> str = <span class="str">""</span> <span class="kwrd">Then</span></pre><pre class="alt">
            <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre>
        <span class="kwrd">Next</span></pre><pre class="alt">
        Console.WriteLine(<span class="str">"花費時間: "</span> &amp; sw.ElapsedMilliseconds)</pre><pre>
 </pre><pre class="alt">
        Console.WriteLine(<span class="str">"str = String.Empty"</span>)</pre><pre>
        sw.Reset()</pre><pre class="alt">
        sw.Start()</pre><pre>
        <span class="kwrd">For</span> i <span class="kwrd">As</span> <span class="kwrd">Integer</span> = 1 <span class="kwrd">To</span> n</pre><pre class="alt">
            <span class="kwrd">If</span> str = <span class="kwrd">String</span>.Empty <span class="kwrd">Then</span></pre><pre>
            <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre class="alt">
        <span class="kwrd">Next</span></pre><pre>
        Console.WriteLine(<span class="str">"花費時間: "</span> &amp; sw.ElapsedMilliseconds)</pre><pre class="alt">
 </pre><pre>
 </pre><pre class="alt">
        Console.WriteLine(<span class="str">"String.IsNullOrEmpty(str)"</span>)</pre><pre>
        sw.Reset()</pre><pre class="alt">
        sw.Start()</pre><pre>
        <span class="kwrd">For</span> i <span class="kwrd">As</span> <span class="kwrd">Integer</span> = 1 <span class="kwrd">To</span> n</pre><pre class="alt">
            <span class="kwrd">If</span> <span class="kwrd">String</span>.IsNullOrEmpty(str) <span class="kwrd">Then</span></pre><pre>
            <span class="kwrd">End</span> <span class="kwrd">If</span></pre><pre class="alt">
        <span class="kwrd">Next</span></pre><pre>
        Console.WriteLine(<span class="str">"花費時間: "</span> &amp; sw.ElapsedMilliseconds)</pre><pre class="alt">
 </pre><pre>
       </pre><pre class="alt">
    <span class="kwrd">End</span> Sub</pre></div></div><p> </p><p>執行結果如下：</p><p><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" width="620" height="484" src="\images\posts\7461\image8_thumb.png" /></a> </p><p>可以看出 String.IsNullOrEmpty 函式的效能與自行混用 str Is Nothing 與 Is String.Empty 判斷方法來達到相同目的的效能差不多。<a href="http://files.dotblogs.com.tw/larrynung/0903/be8824870650_1256F/image_12.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" width="490" height="651" src="\images\posts\7461\image_thumb_5.png" /></a></p><p>經過以上三個實驗，對於字串為空的判斷相信已有相當的了解，若能清楚分辨其功用與使用的時機，多少都能增進程式的效能。像是使用上若只需判斷Nothing或為空的話，應避免誤用會同時判斷的方法(如下例)，就可以避免不必要的OverHead。</p><p><a href="http://files.dotblogs.com.tw/larrynung/0903/be8824870650_1256F/image12.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" width="595" height="228" src="\images\posts\7461\image12_thumb.png" /></p>