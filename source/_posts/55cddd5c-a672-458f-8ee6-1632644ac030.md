---
layout: post
title: "How to use MetaWeblogSharp"
date: 2013-11-06 12:00:00
comments: true
tags: [CSharp]
description: "How to use MetaWeblogSharp"
---
<p>
	簡單紀錄一下怎樣使用MetaWeblogSharp去操控支援MetaWeblog api的Blog。</p>
<p>
	 </p>
<p>
	首先使用NuGet將MetaWeblogSharp組件參考加入。</p>
<p>
	<img alt="image" border="0" height="431" src="\images\posts\55cddd5c-a672-458f-8ee6-1632644ac030\image_thumb_1.png" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" width="644" /></p>
<p>
	 </p>
<p>
	加入命名空間MetaWeblogSharp。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:9ed8b6b8-d74d-4304-844f-259ab4e3abf6" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px">
	<pre class="c#" name="code">
using MetaWeblogSharp;</pre>
</div>
<p>
	 </p>
<p>
	就可以開始進行程式的撰寫。</p>
<p>
	 </p>
<p>
	因為對Blog的操作需要有權限，所以這邊先以Login來說。Login的動作我們需要先取得BlogConnectionInfo的物件，在第一次登入時BlogConnectionInfo物件實體是要自己建立的，建立時我們需要帶入MetaWeblog API的位置以及Blog的帳號密碼。建構子這邊雖然也可以帶入BlogID與BlogURL，但是像ID這樣的東西不太可能是開發時會知道的東西，筆者也不太了解開發者為何這樣設計，這邊筆者是直接將空字串帶入。建立完BlogConnectionInfo物件實體後，我們需要將剛建立好的BlogConnectionInfo物件實體帶入Client的建構子，以建立Client的物件實體，後續我們的操作都是針對這個Client物件實體。特別注意到這邊，建立Client的物件實體並不會實際的透過網路去做登入的動作，所以無法判別帳密是否是正確無誤，故這邊筆者在登入時會嘗試讀取Blog資訊，如果帳密錯誤這邊就會觸發例外並告知錯誤原因，若是帳密無誤，這邊可以取得Blog資訊，筆者藉由將這邊取得的資訊回填，補齊本來沒帶入的BlogID與BlogURL。</p>
<p>
	 </p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:a022d15f-b36e-45aa-b5ed-5a3f25d81f2a" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px">
	<pre class="c#" name="code">
		public static Client Login(string metaWeblogAPIUrl, string id, string password)
		{
			var connectionInfo = new BlogConnectionInfo(
				string.Empty,
				metaWeblogAPIUrl,
				string.Empty,
				id,
				password
				);

			return Login(connectionInfo);
		}

		private static Client Login(BlogConnectionInfo connectionInfo)
		{
			var client = new Client(connectionInfo);

			var blog = client.GetUsersBlogs().FirstOrDefault();

			connectionInfo.BlogID = blog.BlogID;
			connectionInfo.BlogURL = blog.URL;

			return client;
		}</pre>
</div>
<p>
	 </p>
<p>
	登入成功後，若想讓程式下次可以直接登入，可以叫用BlogConnectionInfo的Save成員方法，將連線資訊儲存在本地。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:b6aa5a0b-dfce-47ba-a27e-dfb2f80808d7" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px">
	<pre class="c#" name="code">
client.BlogConnectionInfo.Save("connection.xml");</pre>
</div>
<p>
	 </p>
<p>
	下次程式開啟時可透過BlogConnectionInfo的Load靜態方法，將儲存的連線資訊載回去做登入。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:11b0f6af-ad67-4e9c-a0be-d54c8d79984b" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px">
	<pre class="c#" name="code">
var client = Login(BlogConnectionInfo.Load("connection.xml"));</pre>
</div>
<p>
	 </p>
<p>
	不過這邊筆者要提醒一下，MetaWeblogSharp的Save功能儲存的是未加密的資訊，所以不建議直接採用，比較好應該是自行處理掉這塊。</p>
<p>
	 </p>
<p>
	登入完成實際取得貼文看看，Client的GetRecentPosts成員方法可以讓我們取得最近n筆貼文。若是要取得所有的貼文，我們可以帶個極大的數值給它(MetaWeblog API在這塊感覺有點設計上的缺陷)。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:00d01f7f-99f4-4ecb-ae7e-33f94e4da519" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px">
	<pre class="c#" name="code">
			var allPosts = client.GetRecentPosts(int.MaxValue);
			allPosts.ForEach((post) =&gt;
			{
				Console.WriteLine(post.Title);
				Console.WriteLine(post.Link);
				Console.WriteLine(new string('=', 78));
			});</pre>
</div>
<p>
	 </p>
<p>
	<img alt="image" border="0" height="423" src="\images\posts\55cddd5c-a672-458f-8ee6-1632644ac030\image_thumb_2.png" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" width="644" /></p>
<p>
	 </p>
<p>
	PostInfo內Title、Link、Description這些會是我們比較關注的，因為它是文章的標題、相對路徑、以及內文。</p>
<p>
	 </p>
<p>
	另外我們比較關注的可能就是文章的位置。不過因為MetaWeblogSharp在這塊的實作上有些問題，所以取得的PostInfo其PremaLink會永遠是Null。當然如果要從PostInfo.Link以及部落格位置去兜出PremaLink也是可以，但總是不夠方便。</p>
<p>
	<img alt="image" border="0" height="135" src="\images\posts\55cddd5c-a672-458f-8ee6-1632644ac030\image_thumb_3.png" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" width="644" /></p>
<p>
	 </p>
<p>
	好在它的RawData裡面確實是有東西的，所以這邊我們可以改從RawData那邊去撈出PremaLink。</p>
<p>
	<img alt="image" border="0" height="313" src="\images\posts\55cddd5c-a672-458f-8ee6-1632644ac030\image_thumb_4.png" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" width="644" /></p>
<p>
	 </p>
<p>
	像是下面這樣撰寫：</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:bb0ff027-99e2-4e76-b6f8-140211abb225" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px">
	<pre class="c#" name="code">
var permalink = ((post.RawData as MetaWeblogSharp.XmlRPC.Struct)["permalink"] as MetaWeblogSharp.XmlRPC.StringValue).String;</pre>
</div>
<p>
	 </p>
<p>
	Permalink就可以確實的撈出。</p>
<p>
	<img alt="image" border="0" height="187" src="\images\posts\55cddd5c-a672-458f-8ee6-1632644ac030\image_thumb_5.png" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" width="644" /></p>
<p>
	 </p>
<p>
	除此之外文章的Category可能也是我們關注的重點，這邊一樣也是得從RawData內去撈。像是下面這樣：</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:d1d1c260-1b50-4e94-be5e-a2e3a4b1ff67" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px">
	<pre class="c#" name="code">
var categories = ((post.RawData as MetaWeblogSharp.XmlRPC.Struct)["categories"] as MetaWeblogSharp.XmlRPC.Array).OfType&lt;MetaWeblogSharp.XmlRPC.StringValue&gt;().Select(item =&gt; item.String).ToArray();</pre>
</div>
<p>
	<img alt="image" border="0" height="370" src="\images\posts\55cddd5c-a672-458f-8ee6-1632644ac030\image_thumb_6.png" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" width="644" /></p>
<p>
	 </p>
<p>
	其它比較簡單的操作應該看一下就會了。像是用Client.GetPost取得特定的文章。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:29e19c80-4c43-44fc-a953-70ca3cc6daa2" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px">
	<pre class="c#" name="code">
var post = client.GetPost(postID);</pre>
</div>
<p>
	 </p>
<p>
	用Client.DeletePost刪除特定的文章</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:a4b81865-0ae9-4e0f-9241-c3b9b44b36d1" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px">
	<pre class="c#" name="code">
client.DeletePost(post.PostID);</pre>
</div>
<p>
	 </p>
<p>
	用Client.EditPost編輯特定的文章</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:cd1eac9b-e2c3-48fb-aba6-0dcb4ffc3b41" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px">
	<pre class="c#" name="code">
client.EditPost(post.PostID, "NewTitle", "NewDescription", null, true);
</pre>
</div>
<p>
	 </p>
<p>
	用Client.NewMediaObject上傳檔案</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:126d7861-aad5-459d-9297-b1c941251b1c" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px">
	<pre class="c#" name="code">
var bytes = File.ReadAllBytes("test1.png");
var mo = client.NewMediaObject("foo.png", "image/png", bytes);</pre>
</div>
<p>
	 </p>
<p>
	以及用Client.NewPost產生貼文</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:63160871-25cb-495e-9628-560a8859ccd8" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px">
	<pre class="c#" name="code">
var categories1 = new List&lt;string&gt; { "A", "B", "C" };
var new_post_id = client.NewPost(title, body, categories1, true);</pre>
</div>
<p>
	 </p>
<h2>
	Link</h2>
<ul>
	<li>
		MetaWeblogSharp - Home</li>
</ul>
