---
layout: post
title: "How to fix HttpListener Access Denied"
date: 2013-11-06 12:00:00
comments: true
categories: 
description: "How to fix HttpListener Access Denied"
---
<p>最近開發中的專案程式發生了一些狀況，有的時候安裝完運行就會直接掛掉，無論怎麼重開都無法修復，連用程式去運行除錯也會跟著發生例外錯誤。若是用管理員權限去運行程式卻又可以正常運作，或是將它移除再安裝也有可能就修復了。唯一的線索就是當錯誤發生時用程式除錯可看到問題是在HttpListener.Prefixes.Add這邊會有存取被拒的問題。</p>  <p><img style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" border="0" alt="image" src="\images\posts\726dca0d-0f5f-4561-b500-4cd1ede464a3\image_thumb.png" width="644" height="301" /></a></p>  <p> </p>  <p>這樣的線索我還是有點猜不透，若是存取被拒應該是always發生的，怎麼會有的時候就加的進去？上網查到也有人碰到類似的問題，依據<a href="http://stackoverflow.com/questions/4019466/httplistener-access-denied-c-sharp-windows-7" target="_blank">HttpListener Access Denied c# windows 7</a>這篇的討論，看來存取被拒滿像是UAC造成的，要避免這樣的問題只有下netsh http add urlacl命令跟系統註冊，像是下面這樣：</p>  <p><a href="http://files.dotblogs.com.tw/larrynung/1303/1353b21c4d18_11CA4/ScreenClip(6)_2.png"><img style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" border="0" alt="ScreenClip(6)" src="\images\posts\726dca0d-0f5f-4561-b500-4cd1ede464a3\ScreenClip(6)_thumb.png" width="681" height="447" /></a></p>  <p> </p>  <p>註冊後可再下netsh http show urlacl查閱是否已經跟系統註冊成功。</p>  <p><a href="http://files.dotblogs.com.tw/larrynung/1303/1353b21c4d18_11CA4/ScreenClip(5)_2.png"><img style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" border="0" alt="ScreenClip(5)" src="\images\posts\726dca0d-0f5f-4561-b500-4cd1ede464a3\ScreenClip(5)_thumb.png" width="679" height="446" /></a></p>  <p> </p>  <p>註冊成功可以在裡面看到剛註冊的url位置。</p>  <p><a href="http://files.dotblogs.com.tw/larrynung/1303/1353b21c4d18_11CA4/ScreenClip(8)_2.png"><img style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" border="0" alt="ScreenClip(8)" src="\images\posts\726dca0d-0f5f-4561-b500-4cd1ede464a3\ScreenClip(8)_thumb.png" width="681" height="447" /></a></p>  <p> </p>  <p>註冊完畢後，HttpListener.Prefixes.Add就不會有存取被拒的問題了。</p>  <p> </p>  <p>若是想要取消註冊，可以用netsh http delete urlacl命令。</p>  <p><a href="http://files.dotblogs.com.tw/larrynung/1303/1353b21c4d18_11CA4/ScreenClip(7)_2.png"><img style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px" border="0" alt="ScreenClip(7)" src="\images\posts\726dca0d-0f5f-4561-b500-4cd1ede464a3\ScreenClip(7)_thumb.png" width="681" height="447" /></p>  <p> </p>  <p>這邊要注意的是，netsh這些命令因為要跟系統註冊，還是需要管理者權限，但是我們可以將這動作提到安裝程式這邊去做，由安裝程式要求管理者權限就好了。若是安裝包是用wix去做的，可像下面這樣設定自訂動作：</p>  <div id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:8a5acca9-1e76-4851-b2a3-4c2aa838680f" class="wlWriterSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"><pre name="code" class="xml">    ...
    &lt;CustomAction Id="AddUrlAcl" Directory="INSTALLLOCATION"
                      ExeCommand="[SystemFolder]netsh.exe http add urlacl url=http://+:9981/ user=users"
                      Return="ignore" Execute="deferred" /&gt;
    &lt;CustomAction Id="RemoveUrlAcl" Directory="INSTALLLOCATION"
                      ExeCommand="[SystemFolder]netsh.exe http delete urlacl url=http://+:9981/"
                      Return="ignore" Execute="deferred" /&gt;
    ...
    &lt;InstallExecuteSequence&gt;
    ...
    &lt;Custom Action="RemoveUrlAcl" Before="InstallFinalize"&gt;&lt;![CDATA[Installed AND VersionNT &gt;= 601]]&gt;&lt;/Custom&gt;
    &lt;Custom Action="AddUrlAcl" Before="InstallFinalize"&gt;&lt;![CDATA[NOT Installed AND VersionNT &gt;= 601]]&gt;&lt;/Custom&gt;
    ...
    &lt;/InstallExecuteSequence&gt;
    ...
</pre></div>

<p> </p>

<p>這樣安裝程式就會在安裝時順便幫我們去做這些處理。</p>

<p> </p>

<h2>Link</h2>

<ul>
  <li>HttpListener Access Denied c# windows 7</li>

  <li>add urlacl (Windows)</li>

  <li>delete urlacl (Windows)</li>

  <li>設定 HTTP 和 HTTPS</li>
</ul>