---
layout: post
title: "[C#][Extension Method]Get directory size"
date: 2013-11-06 12:00:00
comments: true
categories: 
description: "[C#][Extension Method]Get directory size"
---
<p>
	使用.NET程式要取得指定目錄的大小，沒辦法像取得檔案大小一樣的簡單，沒有現成的屬性可以取用，必須要遶點路去達到這樣的功能。像是MSDN中的Directory 類別這篇，裡面範例有一道叫做DirSize的Function就是在做這件事情。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:db4ba6cd-4dd6-47e0-b5bc-ae7251d04948" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#" name="code">
    public static long DirSize(DirectoryInfo d) 
    {    
        long Size = 0;    
        // Add file sizes.
        FileInfo[] fis = d.GetFiles();
        foreach (FileInfo fi in fis) 
        {      
            Size += fi.Length;    
        }
        // Add subdirectory sizes.
        DirectoryInfo[] dis = d.GetDirectories();
        foreach (DirectoryInfo di in dis) 
        {
            Size += DirSize(di);   
        }
        return(Size);  
    }</pre>
</div>
<p>
	 </p>
<p>
	可以看到這道Function就只是利用遞回去將目錄裡面所有的檔案大小加起來，除了醜了點外，並沒有什麼特別難的處理。這邊也可以不需要利用遞迴，改用Directory.GetFiles搭配Linq去取得目錄大小，效果是一樣的。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:9f14a410-b7de-46fd-9f94-25de889d53d5" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#" name="code">
		static long GetDirSize(string path)
		{
			return (from item in Directory.GetFiles(path, "*.*", SearchOption.AllDirectories)
						select new FileInfo(item).Length).Sum();
		}</pre>
</div>
<p>
	 </p>
<p>
	除了去計算目錄內的檔案總大小外，我們也可以直接取得目錄的大小。使用前需先將Microsoft  Scripting  Runtime Com組件加入參考。</p>
<p>
	<img alt="image" border="0" height="372" src="\images\posts\06c35379-7270-46a0-abf3-1ca0cb4de14c\image6_thumb.png" style="border-bottom: 0px; border-left: 0px; border-top: 0px; border-right: 0px" width="644" /></p>
<p>
	 </p>
<p>
	建立出Sctipting.FileSystemObjectClass物件後，呼叫GetFolder成員方法並帶入指定的目錄，該函式會回傳回Folder物件，透過Folder.Size就可以取得目錄的大小。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:ff23707b-9c7e-4975-9139-b8bf32f85f14" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#" name="code">
		static long GetFolderSize(string folder)
		{
			return long.Parse((new Scripting.FileSystemObjectClass()).GetFolder(folder).Size.ToString());
		}</pre>
</div>
<p>
	 </p>
<p>
	這邊強力榔頭大有在如何取得資料夾容量大小這篇討論中提供用反射來做的方法，可以不用將參考加入就直接使用。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:d5516560-eb23-4152-bfaa-62b53298bc9e" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#" name="code">
		static long GetFolderSize(string folder) 
		{
			Type tp = Type.GetTypeFromProgID("Scripting.FileSystemObject");
			object fso = Activator.CreateInstance(tp);
			object fd = tp.InvokeMember("GetFolder", BindingFlags.InvokeMethod, null, fso, new object[] { folder });
			long ret = Convert.ToInt64(tp.InvokeMember("Size", BindingFlags.GetProperty, null, fd, null));
			Marshal.ReleaseComObject(fso);
			return ret;
		}</pre>
</div>
<p>
	 </p>
<p>
	在.NET取得目錄大小的方法主要大概就是這幾種，以筆者來說，以簡單乾淨來說筆者是喜歡Linq加總的寫法，但是加總的做法總是感覺比較慢，直覺能直接透過系統去讀取目錄大小是最快，但又不想加入額外的參考，對於用反射來做又有點又臭又長，到底哪種方法比較好呢?這邊筆者做了一個簡單的測試，測試的程式如下：</p>
<p>
	 </p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:ace6be75-edac-4a2a-9e2c-5a3cda926fc1" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#" name="code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.IO;
using System.Reflection;
using System.Runtime.InteropServices;
using System.Diagnostics;


namespace ConsoleApplication8
{
	class Program
	{
		static void Main(string[] args)
		{
			GetFolderSize(@"C:\Program Files");
			GetDirSize(@"C:\Program Files");
			DirSize(new DirectoryInfo(@"C:\Program Files"));

			var sw = Stopwatch.StartNew();
			Console.WriteLine(GetFolderSize(@"C:\Program Files"));
			Console.WriteLine(sw.ElapsedMilliseconds);

			sw.Stop();
			sw.Reset();
			sw.Start();

			Console.WriteLine(GetDirSize(@"C:\Program Files"));
			Console.WriteLine(sw.ElapsedMilliseconds);

			sw.Stop();
			sw.Reset();
			sw.Start();

			Console.WriteLine(DirSize(new DirectoryInfo(@"C:\Program Files")));
			Console.WriteLine(sw.ElapsedMilliseconds);
		}

		static long GetDirSize(string path)
		{
			return (from item in Directory.GetFiles(path, "*.*", SearchOption.AllDirectories)
					select new FileInfo(item).Length).Sum();
		}

		static long GetFolderSize(string folder) // 取得資料夾大小 
		{
			return long.Parse((new Scripting.FileSystemObjectClass()).GetFolder(folder).Size.ToString());
		}

		public static long DirSize(DirectoryInfo d)
		{
			long Size = 0;
			// Add file sizes.
			FileInfo[] fis = d.GetFiles();
			foreach (FileInfo fi in fis)
			{
				Size += fi.Length;
			}
			// Add subdirectory sizes.
			DirectoryInfo[] dis = d.GetDirectories();
			foreach (DirectoryInfo di in dis)
			{
				Size += DirSize(di);
			}
			return (Size);
		}
	}
}</pre>
</div>
<p>
	 </p>
<p>
	經過測試很顯然的直接加總的方法是比較慢的，而且慢了好幾倍。</p>
<p>
	<img alt="image" border="0" height="558" src="\images\posts\06c35379-7270-46a0-abf3-1ca0cb4de14c\image_thumb_4.png" style="border-bottom: 0px; border-left: 0px; border-top: 0px; border-right: 0px" width="681" /></p>
<p>
	 </p>
<p>
	既然測試結果指出直接去跟系統要是最快的方法，所以還是必須去面對上面又臭又長的反射，好在.NET 3.5以後有擴充方法可以用，索性就把它包成DirectoryInfo的擴充方法吧。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:4179e9fa-9aa0-47f6-a984-7a4780fa9504" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#" name="code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.IO;
using System.Reflection;
using System.Runtime.InteropServices;

public static class DirectoryInfoExtension
{
	public static long GetSize(this DirectoryInfo dirInfo) 
	{
		Type tp = Type.GetTypeFromProgID("Scripting.FileSystemObject");
		object fso = Activator.CreateInstance(tp);
		object fd = tp.InvokeMember("GetFolder", BindingFlags.InvokeMethod, null, fso, new object[] { dirInfo.FullName });
		long ret = Convert.ToInt64(tp.InvokeMember("Size", BindingFlags.GetProperty, null, fd, null));
		Marshal.ReleaseComObject(fso);
		return ret;
	}
}
</pre>
</div>
<p>
	 </p>
<h2>
	Link</h2>
<ul>
	<li>
		C# Get Directory Size</li>
	<li>
		Directory 類別</li>
	<li>
		如何取得資料夾容量大小</li>
	<li>
		在c#中直接取得目錄大小的方法</li>
</ul>
