---
layout: post
title: "[C#]Effective C# 條款八： 確保0為值類型的有效狀態"
date: 2009-10-16 09:04:21
comments: true
tags: [CSharp]
description: "[C#]Effective C# 條款八： 確保0為值類型的有效狀態"
---
<p>
	.NET程式在物件初始時，變數初始器會將成員變數做初始化的動作。對於值類型的成員變數來說，會被初始為0值。因此我們應將0視為值類型的默認值。</p>
<p>
	 </p>
<p>
	以列舉型別來看，假設今天我有一個列舉型別：</p>
<div class="wlWriterEditableSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:6cceb1d1-025e-43de-acc4-4cdde7a670df" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#:nocontrols" name="code">
	enum Sex
    {
        Boy=1,
        Girl=2
    }</pre>
</div>
<p>
	 </p>
<p>
	 </p>
<p>
	 </p>
<p>
	其列舉值並未從0，而是從1開始。則初始值0對該列舉來說，是一個無效的狀態。程式也可能因此無法正常運作。像是：</p>
<div class="wlWriterEditableSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:59951ab1-5485-4914-a9ce-51fe02c231e3" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#:nocontrols" name="code">
	class Program
    {
        static void Main(string[] args)
        {
            Person p=new Person();
            //p.Sex = Sex.Boy;
            Console.WriteLine(p.Sex.ToString ());        
        }
    }
    enum Sex
    {
        Boy = 1,
        Girl = 2
    }
    struct Person
    {
        public String Name;
        public Sex Sex ;
    }</pre>
</div>
<p>
	 </p>
<p>
	 </p>
<p>
	 </p>
<p>
	運行結果如下：</p>
<p>
	<img alt="image" border="0" height="159" src="\images\posts\11082\image_thumb.png" style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" width="529" /></p>
<p>
	 </p>
<p>
	但在正常的情況下，列舉值應該要在列舉範圍內，運行結果應顯示如下這般：</p>
<p>
	<img alt="image" border="0" height="159" src="\images\posts\11082\image4_thumb.png" style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" width="529" /></p>
<p>
	 </p>
<p>
	這樣的問題我們無法透過建構子給予初始值來解決，因為就算指定了具備參數的建構子。</p>
<div class="wlWriterEditableSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:df764c86-43be-49af-af15-5dac904abf2f" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#:nocontrols" name="code">
	struct Person
    {
        public String Name;
        public Sex Sex ;
        public Person(String name,Sex sex)
        {
            this.Name = name;
            this.Sex = sex;
        }
    }</pre>
</div>
<p>
	 </p>
<p>
	 </p>
<p>
	 </p>
<p>
	 </p>
<p>
	 </p>
<p>
	 </p>
<p>
	 </p>
<p>
	對於值類型來說仍有預設建構子可以使用。像是：</p>
<div class="wlWriterEditableSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:bb7f7226-6be9-49fc-8d2b-873db64e64c7" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#:nocontrols" name="code">
	class Program
    {
        static void Main(string[] args)
        {
            Person p=new Person();
            Console.WriteLine(p.Sex.ToString ());        
        }
    }
    enum Sex
    {
        Boy = 1,
        Girl = 2
    }

    struct Person
    {
        public String Name;
        public Sex Sex;

        public Person(String name, Sex sex)
        {
            this.Name = name;
            this.Sex = sex;
        }
    }</pre>
</div>
<p>
	 </p>
<p>
	 </p>
<p>
	且值類型的預設建構子無法自行撰寫，若嘗試撰寫編譯器會發出"Structs cannot contain explicit parameterless constructors"的錯誤。</p>
<p>
	<img alt="image" border="0" height="111" src="\images\posts\11082\image_thumb_2.png" style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" width="402" /></p>
<p>
	 </p>
<p>
	而若想透過變數初始器來做設定的動作，編譯器也會以"cannot have instance field initializers"錯誤告知。</p>
<p>
	<img alt="image" border="0" height="96" src="\images\posts\11082\image_thumb_3.png" style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" width="428" /></p>
<p>
	 </p>
<p>
	 </p>
<p>
	 </p>
<p>
	 </p>
<p>
	因此我們在使用值類型時特別留意其初始值，確保0為值類型的有效狀態，避免上述問題的發生。就像這樣：</p>
<div class="wlWriterEditableSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:7929831a-d14f-4872-ae71-37805bb48b58" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#:nocontrols" name="code">
	class Program
    {
        static void Main(string[] args)
        {
            Person p=new Person();
            Console.WriteLine(p.Sex.ToString ());        
        }
    }
    enum Sex
    {
        NotSet = 0,
        Boy = 1,
        Girl = 2
    }

    struct Person
    {
        public String Name;
        public Sex Sex;

        public Person(String name, Sex sex)
        {
            this.Name = name;
            this.Sex = sex;
        }
    }</pre>
</div>
<p>
	 </p>
<p>
	 </p>
<p>
	除此之外，當撰寫設有Flags屬性的列舉型別，我們也要特別留意。除必須確保初始值0為有效狀態外，還需讓其值為沒有設定任何標記的狀態。像是：</p>
<div class="wlWriterEditableSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:61e56b70-5aa4-4c68-a9f7-9a140e7bd327" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#:nocontrols" name="code">
	[Flags]
public enum Styles
{
    None=0,
    Flat=1.
    Sunken=2,
    Raised=4
}</pre>
</div>
<p>
	 </p>
<p>
	 </p>
<p>
	 </p>
<p>
	這是因為設有Flags屬性的列舉型態，我們可能會拿來做像下面這樣的運算：</p>
<div class="wlWriterEditableSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:a2b13bd4-56d7-4eb4-939d-6a16dc850c1d" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#:nocontrols" name="code">
	if((flag &amp; Styles.Flat) != 0)
    DoFlatThings();</pre>
</div>
<p>
	 </p>
<p>
	 </p>
<p>
	當Flat是0的話，判斷式依舊為false，達不到預期的效果。不過，這例子只是告知建議遵守該條款的原因。事實上，這樣的問題可以像下面這樣避開：</p>
<div class="wlWriterEditableSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:c8d10f2a-8d6c-41d2-9641-b21caf970082" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#:nocontrols" name="code">
	if((flag &amp; Styles.Flat) == Styles.Flat)
    DoFlatThings();</pre>
</div>
