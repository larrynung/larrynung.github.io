---
layout: post
title: "[Performance][C#]同時判斷多個字串是否為數值型態"
date: 2009-12-20 08:08:45
comments: true
tags: [C#,Performance]
description: "[Performance][C#]同時判斷多個字串是否為數值型態"
---
<p>一般來說，在C#中若我們想要判斷字串是否為數值形式。多半我們會利用TryParse、正規表示式這兩種方式來做處理。相關的文章在網路上已經很多了，像是TryParse的方法就可以參閱HOW TO：判斷字串是否表示數值 (C# 程式設計手冊)這篇MSDN文章。</p>  <p> </p>  <p>這邊摘錄MSDN的範例，簡單的帶過：     <br />    </p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:8355b220-81ee-4554-8807-5bdc2580cb4a" class="wlWriterEditableSmartContent"><pre name="code" class="c#:nocontrols">  int i = 0; 
  string s = "108";
  bool result = int.TryParse(s, out i); //i now = 108</pre></div>


<p> </p>

<p>以上就是判斷字串是否為數值的程式寫法，相信這個簡單的程式大家應該都會寫，這邊就不再深入探討。今天要談的重點是當今天碰到要判斷很多字串是否都為數值時，您會怎摸樣去做？</p>

<p>這邊我大概的提出了幾個我能想到的作法，再對其效能做些比較。</p>

<p> </p>

<h2>方法一</h2>

<p>應該是大家最常用的方法，分別判斷所有的字串是否為數值。  <br />

  </p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:245a386e-9055-4932-bcd0-045cbb13c13c" class="wlWriterEditableSmartContent"><pre name="code" class="c#:nocontrols">        static Boolean IsNumeric1(string[] values)
        {
            int tempValue;
            foreach (string value in values)
            {
                if (!int.TryParse(value, out tempValue))
                    return false;
            }
            return true;
        }</pre></div>


<p> </p>

<h2>方法二</h2>

<p>主要是把所有字串先合併成一個字串，再用TryParse作數值判斷的動作。(這個方法需特別注意的是，此種合併的作法可能會讓數值溢位。)  <br /> </p>

<p><strong>方法二之一</strong></p>

<p>不處理負數的情況  <br />

  </p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:018a734d-ef00-476b-b0c3-3d8fd4ed13f5" class="wlWriterEditableSmartContent"><pre name="code" class="c#:nocontrols">        static Boolean IsNumeric2_1(string[] values)
        {
            int tempValue;
            return int.TryParse(string.Join(string.Empty, values), out tempValue);
        }</pre></div>


<p> </p>

<p><strong>方法二之二</strong></p>

<p>處理負數的情況  <br />

  </p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:4a67dca2-ce4e-49b6-b5db-84a097e95510" class="wlWriterEditableSmartContent"><pre name="code" class="c#:nocontrols">        static Boolean IsNumeric2_2(string[] values)
        {
            int tempValue;
            int idx = 0;
            foreach (string value in values)
            {
                values[idx] = value.TrimStart('-');
            }
            return int.TryParse(string.Join(string.Empty, values), out tempValue);
        }</pre></div>


<p> </p>

<h2>方法三</h2>

<p>用正規表示式分別判斷其是否為數值。  <br />

  </p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:ec2b1fd6-0667-4ab7-b0b5-1e2d0074ec6f" class="wlWriterEditableSmartContent"><pre name="code" class="c#:nocontrols">        static Boolean IsNumeric3(string[] values)
        {
            foreach (string value in values)
            {
                if (!Regex.IsMatch(value,@"\d+"))
                    return false;
            }
            return true;
        }</pre></div>


<p> </p>

<p> </p>

<h2>方法四</h2>

<p>把所有字串先合併成一個字串，再用正規表示式作數值判斷的動作。   <br />

  </p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:a81807ff-1c26-480e-86fc-944e0be2b539" class="wlWriterEditableSmartContent"><pre name="code" class="c#:nocontrols">        static Boolean IsNumeric4(string[] values)
        {
            return Regex.IsMatch(string.Join(string.Empty, values), @"\d+");
        }</pre></div>


<p> </p>

<p> </p>

<h2>效能比較</h2>

<p>測試程式如下：     <br />

  </p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:0819aeef-eff0-4aad-b88b-54dc7356ae77" class="wlWriterEditableSmartContent"><pre name="code" class="c#:nocontrols">        static void Main(string[] args)
        {
            //String[] values = InitTestStrings(1);
            String[] values = InitTestStrings(10);
            //String[] values = InitTestStrings(10,1);
            //String[] values = InitTestStrings(10, 2);
            //String[] values = InitTestStrings(10, 3);
            int testCount = 1000000;
            Stopwatch sw = Stopwatch.StartNew();
            for (int idx = 0; idx &lt; testCount; ++idx)
            {
                IsNumeric1(values);
            }
            sw.Stop();
            Console.WriteLine("Method1: " + sw.ElapsedMilliseconds + " ms");

            sw.Reset();
            sw.Start();
            for (int idx = 0; idx &lt; testCount; ++idx)
            {
                IsNumeric2_1(values);
            }
            sw.Stop();
            Console.WriteLine("Method2-1: " + sw.ElapsedMilliseconds + " ms");

            sw.Reset();
            sw.Start();
            for (int idx = 0; idx &lt; testCount; ++idx)
            {
                IsNumeric2_2(values);
            }
            sw.Stop();
            Console.WriteLine("Method2-2: " + sw.ElapsedMilliseconds + " ms");

            sw.Reset();
            sw.Start();
            for (int idx = 0; idx &lt; testCount; ++idx)
            {
                IsNumeric3(values);
            }
            sw.Stop();
            Console.WriteLine("Method3: " + sw.ElapsedMilliseconds + " ms");

            sw.Reset();
            sw.Start();
            for (int idx = 0; idx &lt; testCount; ++idx)
            {
                IsNumeric4(values);
            }
            sw.Stop();
            Console.WriteLine("Method4: " + sw.ElapsedMilliseconds + " ms");
        }

        static string[] InitTestStrings(int count)
        {
            string[] testStrings = new string[count];
            for (int idx = 0; idx &lt; count; ++idx)
            {
                testStrings[idx] = idx.ToString();
            }
            return testStrings;
        }

        static string[] InitTestStrings(int count,int nonValueIndex)
        {
            string[] testStrings = InitTestStrings(count);
            testStrings[nonValueIndex] = "Test";
            return testStrings;
        }</pre></div>


<p> </p>

<p>帶入以下測試條件 ：  <br />

  </p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:48b610eb-4016-4092-afb9-2e56118e1cd3" class="wlWriterEditableSmartContent"><pre name="code" class="c#:nocontrols">String[] values = InitTestStrings(1);</pre></div>


<p> </p>

<p>其運行結果如下： 
  <br /><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="\images\posts\12568\image_thumb_2.png" width="465" height="191" /></p>

<p> </p>

<p>帶入以下測試條件 ：  <br />

  </p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:fdb69bc7-f9da-4674-aa2e-0ac61c0f4386" class="wlWriterEditableSmartContent"><pre name="code" class="c#:nocontrols">            String[] values = InitTestStrings(10);</pre></div>


<p> </p>

<p>其運行結果如下：</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="\images\posts\12568\image_thumb_3.png" width="457" height="223" /></p>

<p> </p>

<p>帶入以下測試條件 ：  <br />

  </p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:e6e6569f-9e2e-4dde-a11a-724bd0154324" class="wlWriterEditableSmartContent"><pre name="code" class="c#:nocontrols">String[] values = InitTestStrings(10,1);</pre></div>


<p> </p>

<p>其運行結果如下：</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="\images\posts\12568\image_thumb_4.png" width="449" height="175" /></p>

<p> </p>

<p>帶入以下測試條件 ：  <br />

  </p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:94dd71c7-702f-4ebc-ad1b-d69276d6c396" class="wlWriterEditableSmartContent"><pre name="code" class="c#:nocontrols">            String[] values = InitTestStrings(10, 2);</pre></div>


<p> </p>

<p>其運行結果如下：</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="\images\posts\12568\image_thumb_5.png" width="521" height="191" /></p>

<p> </p>

<p>帶入以下測試條件 ：  <br />

  </p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:7e652a92-1f85-49f4-b3f0-ffadb1ed1553" class="wlWriterEditableSmartContent"><pre name="code" class="c#:nocontrols">String[] values = InitTestStrings(10, 3);</pre></div>


<p> </p>

<p>其運行結果如下：</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="\images\posts\12568\image_thumb_6.png" width="553" height="191" /></p>

<p> </p>

<p>帶入以下測試條件 ：
  <br />

  </p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:11049a60-d424-4da8-9993-7646742ed0a9" class="wlWriterEditableSmartContent"><pre name="code" class="c#:nocontrols"> String[] values = InitTestStrings(10, 4);</pre></div>


<p> </p>

<p>其運行結果如下：
  <br /><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="\images\posts\12568\image_thumb.png" width="465" height="191" /> </p>

<p> </p>

<p>由以上實驗，我們可以看見的是，在某些條件下，方法二這種先合併字串，再用TryParse的方式效能最佳。某些條件下，先合併字串在集中判斷可以獲得較好的效能。主要取決於字串合併數量的多寡、與第幾個字串不為數值這兩個條件。</p>

<p>實驗下來我們也可以發現，字串處理的OverHead好像比數值判斷來得低很多。因此使用字串合併後再判斷約有7/10的機率可獲取較高的效，另外適時的使用功能不那摸強大的判斷方式，也可以適當的提升效能，而使用正規表示式的方式則是效能最差的判斷方式。</p>

<p>另外一提，有興趣的可以試者把Int.TryParse改為Decimal.TryParse看看，其對效能也有相當的影響，所以依需求用對適當的型別來處理也是很重要的。</p>

<p> </p>

<h2>Link</h2>

<ul>
  <li>Int32.TryParse 方法</li>

  <li>HOW TO：判斷字串是否表示數值 (C# 程式設計手冊)</li>
</ul>