---
layout: post
title: "[C#]C# 4.0 動態繫結 (Dynamic Lookup)"
date: 2009-08-05 09:02:48
comments: true
tags: [C#]
description: "[C#]C# 4.0 動態繫結 (Dynamic Lookup)"
---
<h2>Introduction</h2><p>動態繫結是C# 4.0的特色之一，其功能在現階段與晚期繫結大同小異。有用過VB.NET晚期繫結的，相信都能很快速的上手。主要能讓程式在執行階段才指定型別，並進行動態叫用。</p><blockquote><p>VB.NET在VB2005 (VB 7.0)開始支援晚期繫結 (Late-Binding)</p></blockquote><h2>Support</h2><ul><li>C# 4.0 or latter</li></ul><h2><br />動態繫結</h2><p>動態繫結最大的功能就是能在執行階段才決定指定的型態，並在執行階段做型別檢查，且可動態叫用函示、運算、索引子、屬性、與欄位。不論你的物件是從COM、IronPython、HTML DOM、或是reflection所取得，動態繫結允許你採用一至的方法動態的去叫用它。</p><p>此外，使用動態繫結還有個好處，就是可以精簡程式碼。</p><p>像下面這樣的程式</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:1fa11b0e-e24e-4171-95ec-673f0ee2cf20" class="wlWriterEditableSmartContent"><pre class="c#:nocontrols" name="code">
Calculator calc = GetCalculator();
int sum = calc.Add(10, 20);</pre></div><p> </p><p>在以往要達到動態的效果，我們可能會用反射來寫</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:9c99e371-4493-42ce-a73e-96274e7ea6ca" class="wlWriterEditableSmartContent"><pre class="c#:nocontrols" name="code">
object calc = GetCalculator();
Type calcType = calc.GetType();
object res = calcType.InvokeMember("Add",
    BindingFlags.InvokeMethod, null,
    new object[] { 10, 20 });
int sum = Convert.ToInt32(res);
</pre></div><p> </p><p>或是寫成像下面這樣</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:a7353500-42c1-4992-b388-515784729446" class="wlWriterEditableSmartContent"><pre class="c#:nocontrols" name="code">
ScriptObject calc = GetCalculator();
object res = calc.Invoke("Add", 10, 20);
int sum = Convert.ToInt32(res);</pre></div><p> </p><p>但有了動態繫結我們可以更為精簡</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:8e5754d8-eff3-4c23-b2ee-e8f6d33a13eb" class="wlWriterEditableSmartContent"><pre class="c#:nocontrols" name="code">
dynamic calc = GetCalculator();
int sum = calc.Add(10, 20);</pre></div><blockquote><p>在使用動態繫結時，IDE的IntelliSense功能會無法提示。不用太在意，直接輸入就可以了。若輸入錯誤或該成員不存在，則程式會在執行階段做告知的動作。</p></blockquote><p> </p><h2>使用方式</h2><p>在C# 4.0中要使用動態繫結我們可以使用dynamic關鍵字。讓我們直接來看New Features in C# 4.0文件中的程式碼片段。</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:668b27e7-6555-4578-8ba6-42603aa1f301" class="wlWriterEditableSmartContent"><pre class="c#:nocontrols" name="code">
dynamic d = GetDynamicObject(…);
d.M(7); // calling methods
d.f = d.P; // getting and settings fields and properties
d[“one”] = d[“two”]; // getting and setting thorugh indexers
int i = d + 3; // calling operators
string s = d(5,7); // invoking as a delegate
</pre></div><p>相信多數人光看這個程式碼片段還是很模糊，但起碼能從中了解它能動態叫用方法、欄位與運算子、索引子、委派。</p><p> </p><p>接著我們再看一範例應該就會清楚些</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:35e9805a-48f7-43f9-bf5a-67b628a27424" class="wlWriterEditableSmartContent"><pre class="c#:nocontrols" name="code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace ConsoleApplication16
{
    class Program
    {
        static void Main(string[] args)
        {
            dynamic[] ds = new dynamic[2];
            ds[0] = new System.Windows.Forms.TextBox(){Name="TextBox"};
            ds[1] = new Person() { Name = "Larry" };
            foreach (dynamic d in ds)
            {
                Console.WriteLine(d.Name);
            }
        }
    }
    class Person
    {
        public string Name { get; set; }        
    }
}
</pre></div><p> </p><p>由於不用把型態從Object轉回匿名型別，因此動態繫結也可以用在匿名型別上，真的方便許多,看來以後若要偷懶直接傳遞匿名型別也可以了(不建議也不鼓勵濫用)。</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:1bc4648b-78a8-4baa-8b41-afd4aaf97fe6" class="wlWriterEditableSmartContent"><pre class="c#:nocontrols" name="code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace ConsoleApplication19
{
    class Program
    {
        static void Main(string[] args)
        {
            dynamic d = new { Name = "Larry" };
            Console.WriteLine(d.Name);

            d = GetLarry();
            Console.WriteLine(d.Name);
        }

        static dynamic GetLarry()
        {
            return new { Name = "Larry" };
        }
    }
}
</pre></div><p> </p><p>就算回傳值改為Object也可以使用</p><div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:e4e423f7-9c34-4c4e-a7c6-cc409aebe3c7" class="wlWriterEditableSmartContent"><pre class="c#:nocontrols" name="code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace ConsoleApplication19
{
    class Program
    {
        static void Main(string[] args)
        {
            dynamic d = new { Name = "Larry" };
            Console.WriteLine(d.Name);

            d = GetLarry();
            Console.WriteLine(d.Name);
        }

        static Object GetLarry()
        {
            return new { Name = "Larry" };
        }
    }
}
</pre></div><p> </p><h2>Link</h2><ul><li>C# 4.0（VB 10）與CLR 4.0之驚鴻一瞥</a></li><li><a target="_blank" href="http://blog.miniasp.com/post/2009/02/CSharp-40-New-Features-Dynamic-Lookup-and-Named-and-Optional-Arguments.aspx">C# 4.0 新特性：動態型別、選用參數、具名參數</a></li><li><a target="_blank" href="http://code.msdn.microsoft.com/csharpfuture/Release/ProjectReleases.aspx?ReleaseId=1686">New Features in C# 4.0</a></li><li><a target="_blank" href="http://www.dev102.com/2008/11/03/c-40-dynamic-lookup-are-you-kidding-me/">C# 4.0 Dynamic Lookup - Are You Kidding Me?</a></li><li><a target="_blank" href="http://www.codeproject.com/KB/cs/CSharp4Features.aspx?msg=3110596">C# 4.0's New Features Explained</a></li><li><a href="http://huan-lin.blogspot.com/2009/02/dynamic-binding-in-csharp-4.html">C# 4.0 新功能：動態繫結</a></li><li><a href="http://towardsnext.wordpress.com/2009/03/16/dynamic-lookup-dynamic-type-c-40-part-1/">Dynamic Lookup &amp; dynamic Type, C# 4.0 Part 1</li></ul>