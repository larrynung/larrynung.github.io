---
layout: post
title: "[C#]RNGCryptoServiceProvider亂數產生器"
date: 2010-01-07 12:55:33
comments: true
tags: [C#]
description: "[C#]RNGCryptoServiceProvider亂數產生器"
---
<h2>
	Assemble</h2>
<p>
	mscorlib (在 mscorlib.dll 中)</p>
<p>
	 </p>
<h2>
	Namespace</h2>
<p>
	System.Security.Cryptography</p>
<p>
	 </p>
<h2>
	RNGCryptoServiceProvider</h2>
<p>
	RNGCryptoServiceProvider類別是Thread Safe型別，是使用由密碼編譯服務供應者 (CSP) 提供的實作 (implementation)，實作密碼編譯亂數產生器 (RNG)。它能產生較Random類別這種「有限性數學演算法」還亂的亂數。</p>
<p>
	 </p>
<p>
	在RNGCryptoServiceProvider的成員中，其主要方法有兩個 ：</p>
<table border="1" cellpadding="2" cellspacing="0" width="601">
	<tbody>
		<tr>
			<td valign="top" width="49">
				<p>
					 </p>
			</td>
			<td valign="top" width="150">
				<p>
					名稱</p>
			</td>
			<td valign="top" width="400">
				<p>
					說明</p>
			</td>
		</tr>
		<tr>
			<td valign="top" width="49">
				<p>
					<img alt="Public method" src="\images\posts\12883\ctd75hw2.pubmethod(zh-tw,VS.80).gif" /> <img alt="Supported by the .NET Compact Framework" src="\images\posts\12883\ctd75hw2.CFW(zh-tw,VS.80).gif" /></p>
			</td>
			<td valign="top" width="150">
				<p>
					GetBytes</p>
			</td>
			<td valign="top" width="400">
				<p>
					覆寫。 在位元組陣列中填入在密碼編譯方面強式的隨機值序列。</p>
			</td>
		</tr>
		<tr>
			<td valign="top" width="49">
				<p>
					<img alt="Public method" src="\images\posts\12883\ctd75hw2.pubmethod(zh-tw,VS.80).gif" /> <img alt="Supported by the .NET Compact Framework" src="\images\posts\12883\ctd75hw2.CFW(zh-tw,VS.80).gif" /></p>
			</td>
			<td valign="top" width="150">
				<p>
					GetNonZeroBytes</p>
			</td>
			<td valign="top" width="400">
				<p>
					覆寫。 在位元組陣列中填入在密碼編譯方面強式的隨機非零值序列。</p>
			</td>
		</tr>
	</tbody>
</table>
<p>
	 </p>
<p>
	兩者的用法都是傳入一個Byte陣列，用法大同小異。主要只是差在GetNonZeroBytes所產的隨機值是不為零的而已。</p>
<p>
	 </p>
<p>
	使用步驟主要如下：</p>
<ol>
	<li>
		建立RNGCryptoServiceProvider物件實體</li>
	<li>
		建立欲存放亂數的Byte陣列</li>
	<li>
		呼叫GetBytes或GetNonZeroBytes並帶入Byte陣列</li>
</ol>
<p>
	<img alt="image" border="0" height="93" src="\images\posts\12883\image_thumb.png" style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" width="506" /></p>
<p>
	 </p>
<p>
	簡單的操作範例如下：</p>
<div class="wlWriterEditableSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:3918bc5d-1a22-4e70-add5-2f7608309d23" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#:nocontrols" name="code">
        static void Main(string[] args)
        {
            RNGCryptoServiceProvider rng = new RNGCryptoServiceProvider();
            byte[] random = new Byte[100];
            rng.GetBytes (random);
            foreach (byte b in random)
                Console.Write(b.ToString() + " ");
            Console.WriteLine();
        }</pre>
</div>
<p>
	 </p>
<p>
	 </p>
<p>
	運行結果如下：<br />
	<img alt="image" border="0" height="188" src="\images\posts\12883\image_thumb_1.png" style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" width="504" /></p>
<p>
	 </p>
<p>
	接著測試一下RNGCryptoServiceProvider是否會有跟Random類別一樣，當在極短時間內使用，會因亂數種子一樣而產生相同亂數組的問題。</p>
<div class="wlWriterEditableSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:00e8d31d-e6b3-41f6-a772-2a4f65d1a071" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#:nocontrols" name="code">
        static void Main(string[] args)
        {
            RNGCryptoServiceProvider rng1 = new RNGCryptoServiceProvider();
            RNGCryptoServiceProvider rng2 = new RNGCryptoServiceProvider();
            PrintRandomNumber(rng1);
            Console.WriteLine(new string('=',70));
            PrintRandomNumber(rng2);
        }

        static void PrintRandomNumber(RNGCryptoServiceProvider rng)
        {
            byte[] random = new Byte[100];
            rng.GetBytes(random);
            foreach (byte b in random)
                Console.Write(b.ToString() + " ");
            Console.WriteLine();
        }</pre>
</div>
<p>
	 </p>
<p>
	 </p>
<p>
	測試結果如下：<br />
	<img alt="image" border="0" height="287" src="\images\posts\12883\image_thumb_2.png" style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" width="521" /></p>
<p>
	 </p>
<p>
	依測試結果，我們可以發現使用RNGCryptoServiceProvider，並不會有亂數種子的問題。</p>
<p>
	 </p>
<p>
	另外一提，為方便使用，好心的保哥已經幫我們整理好了簡單的靜態類別。使用上就跟使用Random類別類似。</p>
<div class="wlWriterEditableSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:b728fd42-a84a-4909-af74-0ecb86fa560a" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#:nocontrols" name="code">
using System;
using System.Security.Cryptography;

/// &lt;summary&gt;
/// 使用 RNGCryptoServiceProvider 產生由密碼編譯服務供應者 (CSP) 提供的亂數產生器。
/// &lt;/summary&gt;
public static class RNG
{
    private static RNGCryptoServiceProvider rngp = new RNGCryptoServiceProvider();
    private static byte[] rb = new byte[4];

    /// &lt;summary&gt;
    /// 產生一個非負數的亂數
    /// &lt;/summary&gt;
    public static int Next()
    {
        rngp.GetBytes(rb);
        int value = BitConverter.ToInt32(rb, 0);
        if (value &lt; 0) value = -value;
        return value;
    }
    /// &lt;summary&gt;
    /// 產生一個非負數且最大值 max 以下的亂數
    /// &lt;/summary&gt;
    /// &lt;param name="max"&gt;最大值&lt;/param&gt;
    public static int Next(int max)
    {
        rngp.GetBytes(rb);
        int value = BitConverter.ToInt32(rb, 0);
        value = value % (max + 1);
        if (value &lt; 0) value = -value;
        return value;
    }
    /// &lt;summary&gt;
    /// 產生一個非負數且最小值在 min 以上最大值在 max 以下的亂數
    /// &lt;/summary&gt;
    /// &lt;param name="min"&gt;最小值&lt;/param&gt;
    /// &lt;param name="max"&gt;最大值&lt;/param&gt;
    public static int Next(int min, int max)
    {
        int value = Next(max - min) + min;
        return value;
    }
}</pre>
</div>
<p>
	 </p>
<p>
	 </p>
<p>
	這邊我稍微整理了一下，把保哥的程式包成擴充方法：</p>
<div class="wlWriterEditableSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:1664cb99-e205-4cee-9ed8-fa1e404e4b98" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#:nocontrols" name="code">
using System;
using System.Security.Cryptography;

/// &lt;summary&gt;
/// 使用 RNGCryptoServiceProvider 產生由密碼編譯服務供應者 (CSP) 提供的亂數產生器。
/// &lt;/summary&gt;
public static class RNGCryptoServiceProviderExtensions
{
    private static byte[] rb = new byte[4];

    /// &lt;summary&gt;
    /// 產生一個非負數的亂數
    /// &lt;/summary&gt;
    public static int Next(this RNGCryptoServiceProvider rngp)
    {
        rngp.GetBytes(rb);
        int value = BitConverter.ToInt32(rb, 0);
        return (value &lt; 0)?-value:value;
    }
    /// &lt;summary&gt;
    /// 產生一個非負數且最大值 max 以下的亂數
    /// &lt;/summary&gt;
    /// &lt;param name="max"&gt;最大值&lt;/param&gt;
    public static int Next(this RNGCryptoServiceProvider rngp,int max)
    {
        return Next(rngp) %  (max + 1);
    }
    /// &lt;summary&gt;
    /// 產生一個非負數且最小值在 min 以上最大值在 max 以下的亂數
    /// &lt;/summary&gt;
    /// &lt;param name="min"&gt;最小值&lt;/param&gt;
    /// &lt;param name="max"&gt;最大值&lt;/param&gt;
    public static int Next(this RNGCryptoServiceProvider rngp,int min, int max)
    {
        return Next(rngp, max - min) + min;
    }
}</pre>
</div>
<p>
	 </p>
<p>
	 </p>
<p>
	使用上就會像這樣</p>
<div class="wlWriterEditableSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:b94bd8e4-1775-439f-8520-1c77eaeae8bd" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#:nocontrols" name="code">
            RNGCryptoServiceProvider rng = new RNGCryptoServiceProvider();
            Console.WriteLine (rng.Next(10, 15));</pre>
</div>
<p>
	 </p>
<p>
	 </p>
<h2>
	Link</h2>
<ul>
	<li>
		RNGCryptoServiceProvider 類別</li>
	<li>
		亂數產生器：Random 與 RNGCryptoServiceProvider</li>
	<li>
		生成安全的随机数</li>
</ul>
