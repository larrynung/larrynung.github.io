---
layout: post
title: "Brahma Command Line Parser"
date: 2010-11-16 12:34:12
comments: true
categories: [C#]
description: "Brahma Command Line Parser"
---
<p>
	在研究Brahma這個C#開源的Linq To GPU函式庫時，發現在Brahma網站上有釋出用來解析命令列參數的程式碼片段，稍微玩了一下，隨手做個記錄。</p>
<p>
	程式碼片段可在Code Snippets下載，透過程式碼片段管理員將其匯入至本機的Visual Studio中，程式碼片段如下：</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:f62e6208-498c-444d-9ee7-2f195426fce5" style="padding-right: 0px; display: inline; padding-left: 0px; float: none; padding-bottom: 0px; margin: 0px; padding-top: 0px">
	<pre class="c#" name="code">
	#region CommandLine Arguments Parser 

/* Simple commandline argument parser written by Ananth B.
http://www.ananthonline.net */
static class CommandLine
{
    public class Switch // Class that encapsulates switch data.
    {
        public Switch(string name, Action&lt;IEnumerable&lt;string&gt;&gt; handler, string shortForm)
        {
            Name = name;
            Handler = handler;
            ShortForm = shortForm;
        } 

        public Switch(string name, Action&lt;IEnumerable&lt;string&gt;&gt; handler)
        {
            Name = name;
            Handler = handler;
            ShortForm = null;
        } 

        public string Name
        {
            get;
            private set;
        }
        public string ShortForm
        {
            get;
            private set;
        }
        public Action&lt;IEnumerable&lt;string&gt;&gt; Handler
        {
            get;
            private set;
        } 

        public int InvokeHandler(string[] values)
        {
            Handler(values);
            return 1;
        }
    } 

    /* The regex that extracts names and comma-separated values for switches 
    in the form (&lt;switch&gt;[="value 1",value2,...])+ */
    private static readonly Regex ArgRegex =
        new Regex(@"(?&lt;name&gt;[^=\s]+)=?((?&lt;quoted&gt;\""?)(?&lt;value&gt;(?(quoted)[^\""]+|[^,]+))\""?,?)*",
            RegexOptions.Compiled | RegexOptions.CultureInvariant |
            RegexOptions.ExplicitCapture | RegexOptions.IgnoreCase); 

    private const string NameGroup = "name"; // Names of capture groups
    private const string ValueGroup = "value"; 

    public static void Process(this string[] args, Action printUsage, params Switch[] switches)
    {
        /* Run through all matches in the argument list and if any of the switches 
        match, get the values and invoke the handler we were given. We do a Sum() 
        here for 2 reasons; a) To actually run the handlers
        and b) see if any were invoked at all (each returns 1 if invoked).
        If none were invoked, we simply invoke the printUsage handler. */
        if ((from arg in args
             from Match match in ArgRegex.Matches(arg)
             from s in switches
             where match.Success &amp;&amp;
                 ((string.Compare(match.Groups[NameGroup].Value, s.Name, true) == 0) ||
                 (string.Compare(match.Groups[NameGroup].Value, s.ShortForm, true) == 0))
             select s.InvokeHandler(match.Groups[ValueGroup].Value.Split(','))).Sum() == 0)
            printUsage(); // We didn't find any switches
    }
} 

#endregion </pre>
</div>
<p>
	 </p>
<p>
	該程式碼片段結合擴充方法、Linq、與正規表示式等技術去實現解析命令列參數的功能，解析時會去比對設定的Switch命令類別，藉此將命令列參數解析後帶入給對應的命令去處理。</p>
<p>
	 </p>
<p>
	使用時直接在傳入的命令列參數上呼叫Process</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:c6d36dfc-74e3-4f1f-8cd1-2cfdfbf9c490" style="padding-right: 0px; display: inline; padding-left: 0px; float: none; padding-bottom: 0px; margin: 0px; padding-top: 0px">
	<pre class="c#" name="code">
	args.Process(顯示命令使用說明的函式，命令處理類別集合); </pre>
</div>
<p>
	 </p>
<p>
	其中命令處理類別在建構時需帶入命令名稱、命令對應處理函式、命令縮寫。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:ff0adb36-feb3-4402-bef8-15052fe1a3d0" style="padding-right: 0px; display: inline; padding-left: 0px; float: none; padding-bottom: 0px; margin: 0px; padding-top: 0px">
	<pre class="c#" name="code">
	new CommandLine.Switch (命令名稱,命令對應處理函式,命令縮寫); </pre>
</div>
<p>
	 </p>
<p>
	使用上會像下面這樣：</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:6ebe8521-c5b6-44a5-86da-fac321b4fe42" style="padding-right: 0px; display: inline; padding-left: 0px; float: none; padding-bottom: 0px; margin: 0px; padding-top: 0px">
	<pre class="c#" name="code">
	args.Process(printUsage,new CommandLine.Switch []{
            new CommandLine.Switch ("-Command1",Command1,"-cmd1")            
        }); 

        static void Command1(IEnumerable&lt;string&gt; args)
        {
            ...
        } 

        static void printUsage()
        {            
            ...
        } </pre>
</div>
<p>
	 </p>
<p>
	這邊直接來看個簡單的使用範例：</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:ca9cf405-698b-4947-8822-10ce556e9ff4" style="padding-right: 0px; display: inline; padding-left: 0px; float: none; padding-bottom: 0px; margin: 0px; padding-top: 0px">
	<pre class="c#" name="code">
	static void Main(string[] args)
        { 

            args.Process(printUsage,new CommandLine.Switch []{
                new CommandLine.Switch ("-MessageBox",MessageBoxCommand,"-mbx"),
                new CommandLine.Switch ("-ConsoleWriteLine",ConsoleWriteLineCommand,"-cw")
            });
        } 

        static void printUsage()
        {            
            Console.WriteLine("測試解析命令列參數用命令");
            Console.WriteLine();
            Console.WriteLine("-MessageBox or -mbx: 彈出對話方塊");
            Console.WriteLine("-ConsoleWriteLine or -cw: 顯示主控台訊息");
        } 

        static void MessageBoxCommand(IEnumerable&lt;string&gt; args)
        {
            System.Windows.Forms.MessageBox.Show(args.FirstOrDefault());
        } 

        static void ConsoleWriteLineCommand(IEnumerable&lt;string&gt; args)
        {
            Console.WriteLine(args.FirstOrDefault());
        } </pre>
</div>
<p>
	 </p>
<p>
	以這範例來看，若在命令列參數帶入-cw=test的話：</p>
<p>
	<img alt="image" border="0" height="139" src="\images\posts\19485\image_thumb_1.png" style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" width="369" /></p>
<p>
	 </p>
<p>
	帶入參數-mbx=test的話：</p>
<p>
	<img alt="image" border="0" height="423" src="\images\posts\19485\image_thumb.png" style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" width="644" /></p>
<p>
	 </p>
<p>
	不帶任何參數或是非合法的參數的話：</p>
<p>
	<img alt="image" border="0" height="187" src="\images\posts\19485\image_thumb_2.png" style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" width="425" /></p>
<p>
	 </p>
<p>
	使用起來感覺程式還算十分清楚好維護，在撰寫上也很容易上手，但是彈性上卻稍嫌不足，像是命令名稱與值要用等號隔開、名稱與值中間不能有空格、無法處理不合法參數...等等，使用上這邊要特別注意一下。</p>
<p>
	 </p>
<h2>
	Download</h2>
<p>
	CommandLineParser.zip</p>
<p>
	 </p>
<h2>
	Link</h2>
<ul>
	<li>
		Code Snippets</li>
</ul>
