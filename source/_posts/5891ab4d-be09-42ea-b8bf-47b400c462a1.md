---
layout: post
title: "[C#][JavaScript]WinForm與WebPage的JavaScript互通(一)"
date: 2013-11-06 12:00:00
comments: true
tags: 
description: "[C#][JavaScript]WinForm與WebPage的JavaScript互通(一)"
---
<p>
	有時候我們在開發時會將網頁嵌入WinForm程式之中，把網頁跟WinForm程式做個整合，最常見的就是登入或註冊時將動作導給網頁來做。也有某些程式是把整個WebPage給嵌入，WinForm只是做一個殼，程式的畫面與邏輯完全都是用WebPage的，最多針對一些細節下去調整或做些輔助功能，這樣程式就能很快的導入各個平台使用。這樣的開發方式以後會越來越常碰到，因為網頁的功能越來越強大，尤其是HTML5技術成熟後更是如此。</p>
<p>
	 </p>
<p>
	要以上面的方式下去開發，我們必需對WinForm程式與WebPage之間的交互處理很熟悉才行。</p>
<p>
	 </p>
<p>
	若整個程式核心仍在WinForm，只有部份整合WebPage，可能是在做Social network的OAUTH認證，像這類的處理通常不需太緊密的交互，WinForm程式只需要去監控當前頁面的網址去做些對應的處理，WinForm需要的WebPage資料通常會透過網址的參數或是另外的Restful API取得。</p>
<p>
	 </p>
<p>
	若是整個核心跟界面幾乎都在WebPage的話，WinForm與WebPage就必需要較為緊密的交互，像是WinForm有時必需主動觸發WebPage做事，或是WebPage主動觸發WinForm做事。</p>
<p>
	 </p>
<p>
	以WinForm主動觸發WebPage做事來說，WebBrowser內的Document具有現成的方法名為InvokeScript，就可以很簡單的觸發WebPage內的JavaScript，像是:</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:096243db-cb57-40c6-8a20-4cfb7d9f7cd0" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#" name="code">
webBrowser1.Document.InvokeScript("scriptFuncName");</pre>
</div>
<p>
	 </p>
<p>
	實際的使用情境上會像下面這樣：</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:fcab69f8-c142-40ed-a30c-98d5d4fd1bd4" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#" name="code">
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;

namespace WindowsFormsApplication3
{
    public partial class Form1 : Form
    {
        public Form1()
        {
            InitializeComponent();
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            webBrowser1.DocumentText = @"&lt;script&gt;function ShowAlert(alertMessage) {alert (alertMessage);}&lt;/script&gt;";            
        }

        private void button1_Click(object sender, EventArgs e)
        {
            webBrowser1.Document.InvokeScript("ShowAlert", new object[] { "alert message..." });
        }
    }
}</pre>
</div>
<p>
	<img alt="image" border="0" height="304" src="\images\posts\5891ab4d-be09-42ea-b8bf-47b400c462a1\image_thumb.png" style="border-bottom: 0px; border-left: 0px; border-top: 0px; border-right: 0px" width="304" /></p>
<p>
	 </p>
<p>
	若是要以WebPage主動觸發WinForm做事就比較麻煩些。大概需要四個主要的步驟：</p>
<p>
	1.Set PermissionSet and ComVisibleAttribute attribute<br />
	2.Add C# function call by web<br />
	3.Set WebBrowser.ObjectForScripting <br />
	4.JS use window.external to call C# function</p>
<p>
	 </p>
<p>
	第一步必須在WebBrowser所在表單類別加上PremissionSet與ComVisible屬性。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:7f9123db-f806-430d-a655-6328895217f7" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#" name="code">
[PermissionSet(SecurityAction.Demand, Name = "FullTrust")]
[ComVisible(true)]
public partial class Form1 : Form
{
	...
}</pre>
</div>
<p>
	 </p>
<p>
	第二步必須在WebBrowser所在表單類別中準備個Public Function，給WebPage調用用。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:58a8dca5-3d73-4402-b129-43c607bcaf32" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#" name="code">
    [PermissionSet(SecurityAction.Demand, Name = "FullTrust")]
    [ComVisible(true)]
    public partial class Form1 : Form
    {
        ...
        public void OnWebPageReady()
        {
            webBrowser1.Document.InvokeScript("ShowAlert", new object[] { "WebPage Ready..." });
        }
        ...
    }</pre>
</div>
<p>
	 </p>
<p>
	第三步設定WebBrowser的ObjectForScripting屬性，以這邊的例子來說是設定WebBrowser所在表單類別。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:4153541a-2de5-4e5f-a6ad-4e29513d712a" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#" name="code">
    [PermissionSet(SecurityAction.Demand, Name = "FullTrust")]
    [ComVisible(true)]
    public partial class Form1 : Form
    {
        ...
        private void Form1_Load(object sender, EventArgs e)
        {
            webBrowser1.ObjectForScripting = this;           
        }
        ...
    }</pre>
</div>
<p>
	 </p>
<p>
	第四步是WebPage中的JavaScript必須透過window.external去叫用WinForm中的方法。</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:c66d5a63-0893-4a54-bca3-79b727591d72" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#" name="code">
    [PermissionSet(SecurityAction.Demand, Name = "FullTrust")]
    [ComVisible(true)]
    public partial class Form1 : Form
    {
        ...
        private void Form1_Load(object sender, EventArgs e)
        {
            webBrowser1.ObjectForScripting = this;
            webBrowser1.DocumentText = @"&lt;script&gt;function ShowAlert(alertMessage) {alert (alertMessage);}
            window.external.OnWebPageReady();&lt;/script&gt;";            
        }
        ...
    }</pre>
</div>
<p>
	 </p>
<p>
	完整的實作範例如下：</p>
<div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:b8c65347-dbd9-480b-be4d-e7f153d8c52f" style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px">
	<pre class="c#" name="code">
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.Runtime.InteropServices;
using System.Security.Permissions;

namespace WindowsFormsApplication3
{
    [PermissionSet(SecurityAction.Demand, Name = "FullTrust")]
    [ComVisible(true)]
    public partial class Form1 : Form
    {
        public Form1()
        {
            InitializeComponent();
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            webBrowser1.ObjectForScripting = this;
            webBrowser1.DocumentText = @"&lt;script&gt;function ShowAlert(alertMessage) {alert (alertMessage);}
            window.external.OnWebPageReady();&lt;/script&gt;";            
        }

        private void button1_Click(object sender, EventArgs e)
        {
            webBrowser1.Document.InvokeScript("ShowAlert", new object[] { "alert message..." });
        }

        public void OnWebPageReady()
        {
            webBrowser1.Document.InvokeScript("ShowAlert", new object[] { "WebPage Ready..." });
        }
    }
}</pre>
</div>
<p>
	 </p>
<p>
	運行結果如下：</p>
<p>
	<img alt="image" border="0" height="304" src="\images\posts\5891ab4d-be09-42ea-b8bf-47b400c462a1\image_thumb_1.png" style="border-bottom: 0px; border-left: 0px; border-top: 0px; border-right: 0px" width="304" /></p>
<p>
	 </p>
<h2>
	Link</h2>
<ul>
	<li>
		HtmlDocument.InvokeScript 方法 (String)</li>
	<li>
		HtmlDocument.InvokeScript 方法 (String, Object())</li>
	<li>
		Calling JavaScript in a WebBrowser control from C#</li>
	<li>
		Using WebBrowser.Document.InvokeScript() to mess around with foreign JavaScript</li>
	<li>
		VB.NET/C# and JavaScript communication</li>
	<li>
		Calling JavaScript</li>
	<li>
		[C#]讓Webbrowser中的js直接呼叫Winform的function</li>
	<li>
		WebBrowser.ObjectForScripting Property</li>
	<li>
		WinForm透過WebBrowser與JavaScript溝通</li>
	<li>
		JavaScript extensions: window.external</li>
	<li>
		Calling JavaScript in a WebBrowser control from C#</li>
	<li>
		C# - vertical bandobject with WebBrowser control in it -&gt; Calling C# from JavaScript</li>
	<li>
		C# winform與Javascript的相互調用</li>
</ul>
