---
layout: post
title: "[C#]Google Url Shortening"
date: 2011-08-03 01:30:40
comments: true
categories: [C#]
description: "[C#]Google Url Shortening"
---
<p>Google Url Shortening是Google所提供的短網址服務，能將長網址縮短成短網址，或將縮短後的短網址還原成長網址，另外它也提供了分析資訊與使用者歷史記錄等功能。 </p>  <p> </p>  <p>使用時有的地方像是縮短網址那邊會用到API Key，需先連至APIs Console</a>將你要的服務開啟。</p>  <p><a href="http://files.dotblogs.com.tw/larrynung/1108/CGoogleUrlShortening_B98D/image_2.png"><img style="border-bottom: 0px; border-left: 0px; border-top: 0px; border-right: 0px" border="0" alt="image" src="\images\posts\32506\image_thumb.png" width="644" height="446" /></a> </p>  <p> </p>  <p>再至<a href="https://code.google.com/apis/console#access">API Access</a>取得API Key。</p>  <p><a href="http://files.dotblogs.com.tw/larrynung/1108/CGoogleUrlShortening_B98D/image_4.png"><img style="border-bottom: 0px; border-left: 0px; border-top: 0px; border-right: 0px" border="0" alt="image" src="\images\posts\32506\image_thumb_1.png" width="644" height="415" /></a> </p>  <p> </p>  <p>在縮短網址那邊，處理上是向<a title=" https://www.googleapis.com/urlshortener/v1/url" href="https://www.googleapis.com/urlshortener/v1/url">https://www.googleapis.com/urlshortener/v1/url發送APIKey與Post訊息，ContentType為application/json，其Post內容為{"longUrl": "[長網址]"}。</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:cdb71e36-f36c-4252-8f45-b4cd4f0704f1" class="wlWriterSmartContent"><pre name="code" class="xml">POST https://www.googleapis.com/urlshortener/v1/url
Content-Type: application/json

{"longUrl": "http://www.google.com/"}</pre></div>

<p> </p>

<p>回傳的內容會像下面這樣，有kind、 id、與longUrl，我們多半只需要取得id即可。</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:560d46c4-0c5b-4dac-99bd-4b7372d98541" class="wlWriterSmartContent"><pre name="code" class="xml">{
 "kind": "urlshortener#url",
 "id": "http://goo.gl/fbsS",
 "longUrl": "http://www.google.com/"
}</pre></div>

<p> </p>

<p>以C#實做此概念程式如下；</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:3f5a91c9-3524-494e-b1bf-ea5a91a75dcd" class="wlWriterSmartContent"><pre name="code" class="c#">        public string Shorten(string url)
        {
            if (String.IsNullOrEmpty(url))
                throw new ArgumentNullException("url");

            if (m_APIKey.Length == 0)
                throw new Exception("APIKey not set!");

            const string POST_PATTERN = @"{{""longUrl"": ""{0}""}}";
            const string MATCH_PATTERN = @"""id"": ?""(?&lt;id&gt;.+)""";

            var post = string.Format(POST_PATTERN, url);
            var request = (HttpWebRequest)WebRequest.Create(string.Format(URL_SHORTENER_URL_PATTERN, m_APIKey));
            
            request.Method = "POST";
            request.ContentLength = post.Length;
            request.ContentType = "application/json";
            request.Headers.Add("Cache-Control", "no-cache");

            using (Stream requestStream = request.GetRequestStream())
            {
                var buffer = Encoding.ASCII.GetBytes(post);
                requestStream.Write(buffer, 0, buffer.Length);
            }

            using (var responseStream = request.GetResponse().GetResponseStream())
            {
                using (StreamReader sr = new StreamReader(responseStream))
                {
                    return Regex.Match(sr.ReadToEnd(), MATCH_PATTERN).Groups["id"].Value;
                }
            }
            return string.Empty;
        }</pre></div>

<p> </p>

<p>而在展開短網址方面就更為簡單了，展開的動作只需在https://www.googleapis.com/urlshortener/v1/url後面加上shortUrl的參數，將短網址帶入。</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:074fd570-3702-49f0-8065-0480b864e554" class="wlWriterSmartContent"><pre name="code" class="xml">GET https://www.googleapis.com/urlshortener/v1/url?shortUrl=http://goo.gl/fbsS</pre></div>

<p> </p>

<p>即會回傳像下面這樣的資訊，我們需要的展開後網址即回傳的longUrl。</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:0d61d4f7-56ce-409e-b31b-3a160844376f" class="wlWriterSmartContent"><pre name="code" class="xml">{
 "kind": "urlshortener#url",
 "id": "http://goo.gl/fbsS",
 "longUrl": "http://www.google.com/",
 "status": "OK"
}</pre></div>

<p> </p>

<p>以C#實做此概念的話程式如下：</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:234054fb-c9cd-405a-99b3-c33a9688f058" class="wlWriterSmartContent"><pre name="code" class="c#">        private string GetHTMLSourceCode(string url)
        {
            HttpWebRequest request = (WebRequest.Create(url)) as HttpWebRequest;
            HttpWebResponse response = request.GetResponse() as HttpWebResponse;
            using (StreamReader sr = new StreamReader(response.GetResponseStream()))
            {
                return sr.ReadToEnd();
            }
        }

        public String Expand(string url)
        {
            const string MATCH_PATTERN = @"""longUrl"": ?""(?&lt;longUrl&gt;.+)""";

            var expandUrl = string.Format(EXPAND_URL_PATTERN, url);
            var response = GetHTMLSourceCode(expandUrl);

            return Regex.Match(response, MATCH_PATTERN).Groups["longUrl"].Value;
        }</pre></div>

<p> </p>

<p>這邊有整理個較為完整的Class，有需要的直接取用。</p>

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:15ec353a-d346-4add-948a-67dff5793f54" class="wlWriterSmartContent"><pre name="code" class="c#">using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Net;
using System.IO;
using System.Text.RegularExpressions;

namespace LevelUp.Google
{
    public class GoogleUrlShortener
    {
        #region Const
        const String BASE_API_URL = @"https://www.googleapis.com/urlshortener/v1/url";
        const String SHORTENER_URL_PATTERN = BASE_API_URL + @"?key={0}";
        const String EXPAND_URL_PATTERN =  BASE_API_URL + @"?shortUrl={0}";
        #endregion

        #region Var
        private String _apiKey;
        #endregion

        #region Private Property
        private String m_APIKey 
        {
            get
            {
                if (_apiKey == null)
                    return string.Empty;
                return _apiKey;
            }
            set
            {
                _apiKey = value;
            }
        }
        #endregion

        #region Constructor
        public GoogleUrlShortener(string apiKey)
        {
            if (string.IsNullOrEmpty(apiKey))
                throw new ArgumentNullException("apiKey");

            this.m_APIKey = apiKey;
        }
        #endregion

        #region Private Method
        private string GetHTMLSourceCode(string url)
        {
            HttpWebRequest request = (WebRequest.Create(url)) as HttpWebRequest;
            HttpWebResponse response = request.GetResponse() as HttpWebResponse;
            using (StreamReader sr = new StreamReader(response.GetResponseStream()))
            {
                return sr.ReadToEnd();
            }
        }
        #endregion

        #region Public Method
        public string Shorten(string url)
        {
            if (String.IsNullOrEmpty(url))
                throw new ArgumentNullException("url");

            if (m_APIKey.Length == 0)
                throw new Exception("APIKey not set!");

            const string POST_PATTERN = @"{{""longUrl"": ""{0}""}}";
            const string MATCH_PATTERN = @"""id"": ?""(?&lt;id&gt;.+)""";

            var post = string.Format(POST_PATTERN, url);
            var request = (HttpWebRequest)WebRequest.Create(string.Format(SHORTENER_URL_PATTERN, m_APIKey));
            
            request.Method = "POST";
            request.ContentLength = post.Length;
            request.ContentType = "application/json";
            request.Headers.Add("Cache-Control", "no-cache");

            using (Stream requestStream = request.GetRequestStream())
            {
                var buffer = Encoding.ASCII.GetBytes(post);
                requestStream.Write(buffer, 0, buffer.Length);
            }

            using (var responseStream = request.GetResponse().GetResponseStream())
            {
                using (StreamReader sr = new StreamReader(responseStream))
                {
                    return Regex.Match(sr.ReadToEnd(), MATCH_PATTERN).Groups["id"].Value;
                }
            }
            return string.Empty;
        }

        public String Expand(string url)
        {
            const string MATCH_PATTERN = @"""longUrl"": ?""(?&lt;longUrl&gt;.+)""";

            var expandUrl = string.Format(EXPAND_URL_PATTERN, url);
            var response = GetHTMLSourceCode(expandUrl);

            return Regex.Match(response, MATCH_PATTERN).Groups["longUrl"].Value;
        }
        #endregion
    }
}</pre></div>

<p> </p>

<h2>Link</h2>

<ul>
  <li>Google URL Shortener </li>

  <li>Google URL Shortener API (Labs) </li>

  <li>APIs Console</li>

  <li>API Access</li>
</ul>